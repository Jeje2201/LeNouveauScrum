<body class="fixed-nav sticky-footer" id="page-top">
  <div class="content-wrapper">
    <div class="container-fluid">

      <div class="row">
        <div class="col-lg-3">
          <div id="ListSrint"></div>
        </div>
        <div class="col-lg-3">
          <button type="button" id="modal_button" class="btn btn-block btn-info">
            <i class="fa fa-plus" aria-hidden="true"></i>&nbsp;Planification</button>
        </div>
        <div class="col-lg-3">
          <button type="button" id="Boutton_Modal_ApiPivotal" class="btn btn-block btn-info">
            <i class="fa fa-plus" aria-hidden="true"></i>&nbsp;Api Planif</button>
        </div>
        <div class="col-lg-3">
          <button type="button" id="ButtonScrumPlaning" class="btn btn-block btn-info">
            <i class="fa fa-plus" aria-hidden="true"></i>&nbsp;Scrum planning </button>
        </div>

      </div>
      <div class="row">
        <div class="col-lg-7">
          <input class="form-control" id="BarreDeRecherche" type="text" placeholder="Rechercher..">
        </div>
      </div>
      <div class="row">
        <div class="col-lg-7">

          <div id="TableListHeuresAttribuees" class="table-responsive table-hover"></div>

        </div>

        <div class="col-lg-3">

          <div id="TableListHeuresAttribueesRessources" class="table-responsive table-hover"></div>
        </div>
        <div class="col-lg-2">
          <div id="TableauListeHeuresAttrbueesProjets" class="table-responsive table-hover"></div>

        </div>
      </div>
    </div>
</body>


<div id="ModalTache" class="modal fade">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body">

        <div class="row">
          <div class="col-lg-6">
              <label>Ressource</label>
            <div id="ListEmploye"> </div>
          </div>

          <div class="col-lg-6">
              <label>Projet</label>
            <div id="ListProjet"></div>
          </div>
      </div>

        <p></p>
        <hr>
        <p></p>

        <u><h5>Heures tâches</h5></u>
        <div class="row">
            <div class="col-lg-9">
              <input class="form-control" name="nbheure" id="nbheure" type="text" placeholder="x+x+x">
            </div>
  
            <div class="col-lg-3">
              <input type="hidden" name="id" id="id" />
              <input type="submit" name="action" id="action" class="btn btn-success" />
            </div>
        </div>
      
        <p></p>

        <u><h5>Objectifs</h5></u>
        <div class="row">
            <div class="col-lg-9">
                <input class="form-control" name="LabelObjectif" id="LabelObjectif" type="text" placeholder="Label objectif">
            </div>
  
            <div class="col-lg-3">
                <input type="submit" class="btn btn-success EnvoyerObjectif" />
            </div>
        </div>

        <p></p>

        <u><h5>Démo</h5></u>
        <div class="row">
  
            <div class="col-lg-3">
                <input type="submit" class="btn btn-success EnvoyerDemo" />
            </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<div id="ModalApi" class="modal fade">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body">
        <div class="row">
            <div class="col-lg-4">
                <label>Ressource</label>
              <div id="ListEmployePivotal"> </div>
            </div>
  
            <div class="col-lg-4">
                <label>Projet</label>
              <div id="ListProjetPivotal"></div>
            </div>

            <div class="col-lg-2">
                <label>&nbsp;</label>
                <div>
                    <button id="ChercherApiPivotal" class="btn btn-info">
                        <i class="fa fa-refresh" aria-hidden="true"></i>&nbsp;Chercher
                    </button>
                </div>
            </div>

            <div class="col-lg-2">
                <label>&nbsp;</label>
                <div>
                  <button type="submit" id="EnvoyerApiPivotal" class="btn btn-success">
                      <i class="fa fa-plus" aria-hidden="true"></i>&nbsp;Envoyer
                  </button>
                </div>
            </div>
        </div>
        <div style="margin-top: 10px" id="totalheure"></div>
        <p></p>
        <hr>
        <p></p>
      
        <div id="ListeTachesApi"></div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<div id="ModalScrumPlaning" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title"></h4>
      </div>
      <div class="modal-body">
        <div class="dropdown">
          <button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown"
            aria-haspopup="true" aria-expanded="false">
            Liste des ressources
          </button>
          <div class="dropdown-menu" style="padding-right: 10px; height: 300px; overflow-y: scroll;" id="ListEmployeCheckBox"
            aria-labelledby="dropdownMenuButton">
          </div>
        </div>

        <br />
        <label>Type de tâche</label>
        <div id="ListTypeTache"></div>
        <br />
        <label>Nombre d'heures</label>
        <input class="form-control" name="nbheure2" id="nbheure2" type="number" min="1" value="1">
        <br />
      </div>
      <div class="modal-footer">
        <input type="hidden" name="id" id="id" />
        <input type="submit" name="aa" id="aa" class="btn btn-success AttribuerHeureScrumPlaning" />
        <button type="button" class="btn btn-default" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>

  $(document).ready(function () {

    RequeteAjax('ListSrint', 'ListeDeroulanteSprint', 'Modele/RequetesAjax.php');
    RequeteAjax('ListEmploye', 'ListeDeroulanteEmployeActifTrieParType', 'Modele/RequetesAjax.php');
    RequeteAjax('ListProjet', 'ListeDeroulanteProjet', 'Modele/RequetesAjax.php');
    RequeteAjax('ListEmployePivotal', 'RessourcePivotal', 'Modele/RequetesAjax.php');
    RequeteAjax('ListProjetPivotal', 'ProjetPivotal', 'Modele/RequetesAjax.php');
    RequeteAjax('ListTypeTache', 'RemplirTypeTache', 'Modele/RequetesAjax.php');
    RequeteAjax('ListEmployeCheckBox', 'ListEmployeCheckBox', 'Modele/RequetesAjax.php');

    RemplirTableau('TableListHeuresAttribuees');
    RemplirTableauRessources('TableListHeuresAttribueesRessources');
    RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')

    BarreDeRecherche('BarreDeRecherche', 'TableListHeuresAttribuees');

    function RemplirTableau(Div) {
      var idAffiche = $('#numeroSprint').val();
      var action = "RemplirTableau";
      $.ajax({
        url: "Modele/ActionAttributionHeure.php",
        method: "POST",
        data: { action: action, idAffiche: idAffiche },
        success: function (data) {
          $('#' + Div + '').html(data);
          GarderLaRecherche('BarreDeRecherche', 'TableListHeuresAttribuees');

        }
      });
    }

    function RemplirTableauRessources(Div) {
      var idAffiche = $('#numeroSprint').val();
      var action = "RemplirTableauRessources";
      $.ajax({
        url: "Modele/ActionAttributionHeure.php",
        method: "POST",
        data: { action: action, idAffiche: idAffiche },
        success: function (data) {
          $('#' + Div + '').html(data);
        }
      });
    }

    function RemplirTableauProjets(Div) {
      var idAffiche = $('#numeroSprint').val();
      var action = "RemplirTableauProjets";
      $.ajax({
        url: "Modele/ActionAttributionHeure.php",
        method: "POST",
        data: { action: action, idAffiche: idAffiche },
        success: function (data) {
          $('#' + Div + '').html(data);
        }
      });
    }

    $('#numeroSprint').change(function () {
      RemplirTableau('TableListHeuresAttribuees');
      RemplirTableauRessources('TableListHeuresAttribueesRessources');
      RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
      ListEmployeActifPlanification('ListEmploye', $('#numeroSprint').val())
    });

    $('#modal_button').click(function () {
      $('#ModalTache').modal('show');
      $('#nbheure').get(0).type = 'text';
      $('#smallinfo').show();
      $('#nbheure').val('');
      $('#action').val('Attribuer');
    });

    $('#ButtonScrumPlaning').click(function () {
      $('#ModalScrumPlaning').modal('show');
      $('.modal-title').text("Attribuer heure Scrum Planning");
      $('#action').val('Attribuer2');
    });

    $('#ButtonObjectif').click(function () {
      $('#ModalObjectif').modal('show');
      $('#action').val('NouvvelObjectif');
    });

    $('#Boutton_Modal_ApiPivotal').click(function () {
      $('#ModalApi').modal('show');
    });

    $('#action').click(function () {
      var idSprint = $('#numeroSprint').val();
      var idEmploye = $('#TypeEmployeOk').val();
      var idProjet = $('#projetId').val();
      var erreur = false
      if ($('#nbheure').attr('type') == 'text') {
        var NombreHeure = $('#nbheure').val().split('+').map(function (item) {
          return parseInt(item);
        });

        NombreHeure.forEach(function (element) {
          if (isNaN(element))
            erreur = true
        });
      }
      else
        var NombreHeure = $('#nbheure').val()

      var id = $('#id').val();
      var action = $('#action').val();

      if (erreur == false) {
        if (idSprint != '' && idEmploye != '' && idProjet != '') {

          $.ajax({
            url: "Modele/ActionAttributionHeure.php",
            method: "POST",
            data: { id: id, idSprint: idSprint, idEmploye: idEmploye, idProjet: idProjet, NombreHeure: NombreHeure, action: action },
            success: function (data) {
              BootstrapAlert(data);
              // $('#ModalTache').modal('hide');
              RemplirTableau('TableListHeuresAttribuees');
              RemplirTableauRessources('TableListHeuresAttribueesRessources');
              RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
            }
          });

          $('#nbheure').val('');

        }
        else
          alert("Tous les champs doivent être plein.");
      }
      else alert("Le champ d'heure comporte une erreur")
    });

    $(document).on('click', '.AttribuerHeureScrumPlaning', function () {

      var idSprint = $('#numeroSprint').val();
      var action = "AttributionScrumPlaning";

      var idEmploye = new Array;
      $('.checkbox:checked').each(function () {
        idEmploye.push($(this).val());
      });

      var idTypeTache = parseInt($('#RemplirTypeTache1').val());
      var NombreHeure = $('#nbheure2').val();
      
      if (idEmploye.length > 0) {
        $.ajax({
          url: "Modele/ActionAttributionHeure.php",
          method: "POST",
          data: { idSprint: idSprint, idEmploye: idEmploye, NombreHeure: NombreHeure, idTypeTache: idTypeTache, action: action },
          success: function (data) {
            BootstrapAlert(data);
            // $('#ModalTache').modal('hide');
            RemplirTableau('TableListHeuresAttribuees');
            RemplirTableauRessources('TableListHeuresAttribueesRessources');
            RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
          }
        });
      }
      else
        alert('Aucune ressource selectionnée ?')
    });

    // Partie demo //

    $(document).on('click', '.EnvoyerDemo', function () {
     
        $.ajax({
          url: "Modele/ActionDemo.php",
          method: "POST",
          data: {idEmploye: $('#TypeEmployeOk').val(), idProjet: $('#projetId').val(), action: "CréerDemo" },
          success: function (data) {
            BootstrapAlert(data);
          }
        });
        $('#LabelDemo').val('');
    });

    $(document).on('click', '.EnvoyerObjectif', function () {
      var idSprint = $('#numeroSprint').val();
      var idProjet = $('#projetId').val();
      var idEmploye = $('#TypeEmployeOk').val();
      var LabelObjectif = $('#LabelObjectif').val();
     
        $.ajax({
          url: "Modele/ActionObjectifs.php",
          method: "POST",
          data: {idSprint: idSprint, LabelObjectif: LabelObjectif, idEmploye: idEmploye, idProjet: idProjet, action: "Créer" },
          success: function (data) {
            BootstrapAlert(data);
          }
        });
        $('#LabelObjectif').val('');
    });

    //select all checkboxes
    $("#TOUTLEMONDE").change(function () {  //"select all" change 
      $(".checkbox").prop('checked', $(this).prop("checked")); //change all ".checkbox" checked status
    });

    //".checkbox" change 
    $('.checkbox').change(function () {
      //uncheck "select all", if one of the listed checkbox item is unchecked
      if (false == $(this).prop("checked")) { //if this item is unchecked
        $("#TOUTLEMONDE").prop('checked', false); //change "select all" checked status to false
      }
      //check "select all" if all checkbox items are checked
      if ($('.checkbox:checked').length == $('.checkbox').length) {
        $("#TOUTLEMONDE").prop('checked', true);
      }
    });

    $(document).on('click', '.update', function () {
      var id = $(this).attr("id");
      var action = "Select";
      $.ajax({
        url: "Modele/ActionAttributionHeure.php",
        method: "POST",
        data: { id: id, action: action },
        dataType: "json",
        success: function (data) {
          $('#ModalTache').modal('show');
          $('.modal-title').text("Changer planification");
          $('#nbheure').get(0).type = 'number';
          $('#smallinfo').hide();
          $('#action').val("Update");
          $('#id').val(id);
          $('#idSprint').val(data.idSprint);
          $('#TypeEmployeOk').val(data.id_Employe);
          $('#projetId').val(data.id_Projet);
          $('#nbheure').val(data.heure);

          SetSelect2('#TypeEmployeOk, #projetId');
        }
      });
    });

    $(document).on('click', '.delete', function () {
      var id = $(this).attr("id");
      if (confirm("Es-tu sûr de vouloir supprimer cette attribution ?")) {
        var action = "Delete";
        $.ajax({
          url: "Modele/ActionAttributionHeure.php",
          method: "POST",
          data: { id: id, action: action },
          success: function (data) {
            RemplirTableau('TableListHeuresAttribuees');
            RemplirTableauRessources('TableListHeuresAttribueesRessources');
            RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
            BootstrapAlert(data);
          }
        })
      }
      else {
        return false;
      }
    });



    $('#ChercherApiPivotal').click(function () {

var htmlDeFin = ""
var ListeErreur = ""

document.getElementById('ListeTachesApi').innerHTML = ""

var projetPivotalId = $('#ProjetApi').val().split('|')[1];
var ressourcePivotalId = $('#RessourceApi').val().split('|')[1];

var myStories

console.log('🎁 Projet: ' + $("#ProjetApi option:selected").text())

////////////////////////////////// Requette qui récupère toutes les stories d'une ressource sur le projet sélectionné
$.ajax({
  url: "https://www.pivotaltracker.com/services/v5/projects/" + projetPivotalId + "/stories",
  beforeSend: function (xhr) {
    xhr.setRequestHeader('X-TrackerToken', '404fd04a04b800e6a9de45b044327cbd');
  },
  type: 'GET',
  dataType: 'json',
  contentType: 'application/json',
  processData: false,
  data: 'filter=mywork:' + ressourcePivotalId,
  error: function(XMLHttpRequest, textStatus, errorThrown) {
     alert("some error");
  },
  success: function (data) {

    //Liste des stories trouvées
    myStories = data;

    ////////////////////////////////////////// Pour chaques stories trouvé, sortir chaque taches
    $.each(myStories, function () {

      Storyname = this.name
      StoryId = this.id

      $.ajax({
        url: "https://www.pivotaltracker.com/services/v5/projects/" + projetPivotalId + "/stories/" + this.id + "/tasks",
        beforeSend: function (xhr) {
          xhr.setRequestHeader('X-TrackerToken', '404fd04a04b800e6a9de45b044327cbd');
        },
        async: false,
        type: 'GET',
        dataType: 'json',
        contentType: 'application/json',
        processData: false,
        success: function (LesTaches) {

          var ToutFait = true

          $.each(LesTaches, function () {
            if (!this.complete) {
              ToutFait = false
            }
          })

          if (LesTaches.length != 0 && ToutFait == false) {
            console.log('   📙 Storie: ' + Storyname)
            htmlDeFin += '<div  style="margin-bottom: 30px;"> <h3>' + Storyname + '</h3>'

            $.each(LesTaches, function () {

              if (this.complete == true) 
                htmlDeFin += ''

              else {
                
                try {
                  var ListeHeures = /.-(.+)/.exec(this.description)[1];
                  console.log('       📃 Une tache à faire : ' + this.description)
                } catch  {
                  console.log("       🔴🔴🔴🔴" + this.description)
                  ListeErreur = this.description
                }

                var RegexGroupeHeure = /([0-9]+)/g
                var InputHeure = '<select onchange="TotalHoursChecked()"><option value="NON">NON</option>'

                match = RegexGroupeHeure.exec(ListeHeures);
                while (match != null) {
                  InputHeure += '<option value=' + match[0] + '>' + match[0] + '</option>'
                  match = RegexGroupeHeure.exec(ListeHeures);
                }
                InputHeure += '</select>'

                htmlDeFin += '<span>' + InputHeure + ' ' + this.description + '</span></br>'
              }
            })
            htmlDeFin += "</div>"
          }
          document.getElementById("ListeTachesApi").innerHTML = htmlDeFin
        }
      });
    })

    //si pas de stories
    if(myStories.length === 0)
      document.getElementById("ListeTachesApi").innerHTML = "<h3>Aucunes stories pour ce projet</h3><label>(si vous êtes sûr du contraire, le problème vient sûrement de l'ID de pivotal tracker renseigné pour le projet ou la ressource en question)</label>"
    
  }
});

    })


    $('#EnvoyerApiPivotal').click(function () {
      if(TotalHoursChecked().length > 2)
        $.ajax({
          url: "Modele/ActionAttributionHeure.php",
          method: "POST",
          data: { action: "CreerTacheApi", ListeTaches: TotalHoursChecked(), Sprint: $('#numeroSprint').val(), Employe: $('#RessourceApi').val().split('|')[0], Projet: $('#ProjetApi').val().split('|')[0]},
          success: function (data) {
            RemplirTableau('TableListHeuresAttribuees');
    RemplirTableauRessources('TableListHeuresAttribueesRessources');
    RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
            BootstrapAlert(data);
            document.getElementById("ListeTachesApi").innerHTML = ""
            document.getElementById("totalheure").innerHTML = ""
          }
        });
      
      else
        alert('0 données choisies');
    })



    SetSelect2('#TypeEmployeOk, #projetId');

  });

  function TotalHoursChecked() {

var cart = [];
var TotalHeures = 0;

cart.push({
  'User': $('#RessourceApi').val().split('|')[0]
});

cart.push({
  'Project': $('#ProjetApi').val().split('|')[0]
});

$('span select').each(function () {

  if (this.value != "NON") {
    TotalHeures = TotalHeures + parseInt(this.value);

    element = {}
    element.heure = parseInt(this.value);
    element.label = /(.+)\.-/.exec($(this).parent()[0].innerText)[1].trim();
    cart.push(element)
  }

})

document.getElementById("totalheure").innerHTML = "Total heures sélectionnées : " + TotalHeures

return cart

}
</script>