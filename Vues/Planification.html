<body class="fixed-nav sticky-footer" id="page-top">
  <div class="content-wrapper">
    <div class="container-fluid">

      <div class="row">
        <div class="col-lg-12">
          <div id="ListSrint"></div>
        </div>
      </div>
      <p></p>
      <div class="row">
        <div class="col-lg-3">
          <button type="button" id="Boutton_Modal_ApiPivotal" class="btn btn-block btn-info">Planification</button>
        </div>
        <div class="col-lg-3">
          <button type="button" id="ButtonScrumPlaning" class="btn btn-block btn-info">Scrum planning </button>
        </div>
        <div class="col-lg-3">
          <button type="button" id="Modal_Objectif" class="btn btn-block btn-info">Objectif</button>
        </div>
        <div class="col-lg-3">
          <button type="button" id="Modal_Demo" class="btn btn-block btn-info">Démo</button>
        </div>

      </div>
      <div class="row">
        <div class="col-lg-7">
          <input class="form-control" id="BarreDeRecherche" type="text" placeholder="Rechercher..">
        </div>
      </div>
      <div class="row">
        <div class="col-lg-7">

          <div id="TableListHeuresAttribuees" style="max-height: 75%;" class="table-responsive table-hover"></div>

        </div>

        <div class="col-lg-3">

          <div id="TableListHeuresAttribueesRessources" style="max-height: 75%;" class="table-responsive table-hover"></div>
        </div>
        <div class="col-lg-2">
          <div id="TableauListeHeuresAttrbueesProjets" style="max-height: 75%;" class="table-responsive table-hover"></div>

        </div>
      </div>
    </div>
</body>


<div id="ModalTache" class="modal fade">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body">

        <div class="row">
          <div class="col-lg-6">
            <label>Ressource</label>
            <div id="ListEmploye"> </div>
          </div>

          <div class="col-lg-6">
            <label>Projet</label>
            <div id="ListProjet"></div>
          </div>
        </div>

        <p></p>
        <hr>
        <p></p>

        <div class="row" id="PartieObjectif">

          <div class="row col-lg-12">
            <h5>&nbsp;&nbsp; Objectifs</h5>
          </div>
          <div class="col-lg-9">
            <input class="form-control" name="LabelObjectif" id="LabelObjectif" type="text"
              placeholder="Label objectif">
          </div>

          <div class="col-lg-3">
            <input type="submit" value="Attribuer" class="btn btn-success EnvoyerObjectif" />
          </div>
        </div>

        <p></p>

        <div class="row" id="PartieDemo">
          <div class="row col-lg-12">
            <h5>&nbsp;&nbsp; Démo</h5>
          </div>
          <div class="col-lg-9">
            <input class="form-control" name="LabelDemo" id="LabelDemo" type="text" placeholder="Label démo">
          </div>

          <div class="col-lg-3">
            <input type="submit" value="Attribuer" class="btn btn-success EnvoyerDemo" />
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<div id="ModalApi" class="modal fade">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-6">
            <label>Ressource</label>
            <div id="ListEmployePivotal"> </div>
          </div>

          <div class="col-lg-6">
            <label>Projet</label>
            <div id="ListProjetPivotal"></div>
          </div>
        </div>
        <p></p>

        <div class="row">
          <div class="row col-lg-12">
            <h5>&nbsp;&nbsp; Planification manuelle</h5>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-9">
            <input class="form-control" name="nbheure" id="nbheure" type="text" placeholder="x+x+x">
          </div>

          <div class="col-lg-3">
            <input type="hidden" name="id" id="id" />
            <input type="submit" name="action" id="action" class="btn btn-success" value="Attribuer" />
          </div>
        </div>

        <p></p>

        <div class="row">
          <div class="row col-lg-12">
            <h5>&nbsp;&nbsp; Pivotal Tracker</h5>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-3">
            <button id="ChercherApiPivotal" class="btn btn-block btn-info">Chercher</button>
          </div>
        </div>

        <input type="hidden" name="TotalHeureAttribuable" id="TotalHeureAttribuable" />

        <div class="FollowAttribuable" >
          <div id="totalheure"></div>
          <button type="submit" id="EnvoyerApiPivotal" class="btn btn-block btn-success">Attribuer</button>
        </div>
        <p></p>

        <div id="ListeTachesApi"></div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<div id="ModalScrumPlaning" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">

        <div class="form-group">
          <label>Ressources</label>
          <div id="ListEmployeCheckBox"></div>
          <input type="checkbox" id="CheckAll">Tout le monde
        </div>

        <div class="form-group">
          <label>Type de tâche</label>
          <div id="ListTypeTache"></div>
        </div>

        <div class="form-group">
          <label>Nombre d'heures</label>
          <input class="form-control" name="nbheure2" id="nbheure2" type="number" min="1" value="1">
        </div>

      </div>
      <div class="modal-footer">
        <input type="hidden" name="id" id="id" />
        <input type="submit" name="aa" id="aa" class="btn btn-success AttribuerHeureScrumPlaning" />
        <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>

  $(document).ready(function () {

    RequeteAjax('ListSrint', 'ListeDeroulanteSprint', 'Modele/RequetesAjax.php');
    RequeteAjax('ListEmploye', 'ListeDeroulanteEmployeActif', 'Modele/RequetesAjax.php');
    RequeteAjax('ListProjet', 'ListeDeroulanteProjet', 'Modele/RequetesAjax.php');
    RequeteAjax('ListEmployePivotal', 'RessourcePivotal', 'Modele/RequetesAjax.php');
    RequeteAjax('ListProjetPivotal', 'ProjetPivotal', 'Modele/RequetesAjax.php');
    RequeteAjax('ListTypeTache', 'RemplirTypeTache', 'Modele/RequetesAjax.php');
    RequeteAjax('ListEmployeCheckBox', 'ListEmployeCheckBox', 'Modele/RequetesAjax.php');

    RemplirTableau('TableListHeuresAttribuees');
    RemplirTableauRessources('TableListHeuresAttribueesRessources');
    RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')

    BarreDeRecherche('BarreDeRecherche', 'TableListHeuresAttribuees');

    function RemplirTableau(Div) {
      $.ajax({
        url: "Modele/Planification.php",
        method: "POST",
        data: {
          action: "RemplirTableau",
          idAffiche: $('#numeroSprint').val()
        },
        success: function (data) {
          $('#' + Div).html(data);
          GarderLaRecherche('BarreDeRecherche', 'TableListHeuresAttribuees');
        }
      });
    }

    function RemplirTableauRessources(Div) {
      $.ajax({
        url: "Modele/Planification.php",
        method: "POST",
        data: {
          action: "RemplirTableauRessources",
          idAffiche: $('#numeroSprint').val()
        },
        success: function (data) {
          $('#' + Div).html(data);
        }
      });
    }

    function RemplirTableauProjets(Div) {
      $.ajax({
        url: "Modele/Planification.php",
        method: "POST",
        data: {
          action: "RemplirTableauProjets",
          idAffiche: $('#numeroSprint').val()
        },
        success: function (data) {
          $('#' + Div).html(data);
        }
      });
    }

    function HeureAttribuable1Ressource() {
      $.ajax({
        url: "Modele/Planification.php",
        method: "POST",
        data: {
          action: "NbHeureRestantePlanifiable",
          Sprint: $('#numeroSprint').val(),
          Employe: $('#RessourceApi').val().split('|')[0]
        },
        dataType: "json",
        success: function (data) {
          $('#TotalHeureAttribuable').val(data.Attribuable);
          document.getElementById("totalheure").innerHTML = "Heures planifiables : " + data.Attribuable + "h"
        }
      });
    }

    $('#numeroSprint').change(function () {
      RemplirTableau('TableListHeuresAttribuees');
      RemplirTableauRessources('TableListHeuresAttribueesRessources');
      RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
      ListEmployeActifPlanification('ListEmploye', $('#numeroSprint').val())
    });

    $('#RessourceApi').change(function () {
      HeureAttribuable1Ressource();
    });

    $('#Modal_Objectif').click(function () {
      $('#ModalTache').modal('show');
      $('#PartieObjectif').show()
      $('#PartieDemo').hide()
    });

    $('#Modal_Demo').click(function () {
      $('#ModalTache').modal('show');
      $('#PartieDemo').show()
      $('#PartieObjectif').hide()
    });

    $('#ButtonScrumPlaning').click(function () {
      $('#ModalScrumPlaning').modal('show');
    });

    $('#ButtonObjectif').click(function () {
      $('#ModalObjectif').modal('show');
      $('#action').val('NouvvelObjectif');
    });

    $('#Boutton_Modal_ApiPivotal').click(function () {
      HeureAttribuable1Ressource();
      document.getElementById("ListeTachesApi").innerHTML = ""
      $('#ModalApi').modal('show');
      $('#EnvoyerApiPivotal').hide()
    });

    $('#action').click(function () {
      var erreur = false

      if ($('#nbheure').attr('type') == 'text') {
        var NombreHeure = $('#nbheure').val().split('+').map(function (item) {
          return parseInt(item);
        });

        NombreHeure.forEach(function (element) {
          if (isNaN(element))
            erreur = true
        });
      }
      else
        var NombreHeure = $('#nbheure').val()

      if (erreur == false) {

        $.ajax({
          url: "Modele/Planification.php",
          method: "POST",
          data: {
            id: $('#id').val(),
            idSprint: $('#numeroSprint').val(),
            idEmploye: $('#RessourceApi').val().split('|')[0],
            idProjet: $('#ProjetApi').val().split('|')[0],
            NombreHeure: NombreHeure,
            action: "Attribuer"
          },
          success: function (data) {
            BootstrapAlertDefaut(data);
            // $('#ModalTache').modal('hide');
            RemplirTableau('TableListHeuresAttribuees');
            RemplirTableauRessources('TableListHeuresAttribueesRessources');
            RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
            HeureAttribuable1Ressource()
          }
        });

        $('#nbheure').val('');
      }
      else BootstrapAlertError("Le champ d'heure comporte une erreur")
    });

    //Créer des heures spéciales scrum planing
    $(document).on('click', '.AttribuerHeureScrumPlaning', function () {

      if ($('#TOUTLEMONDE').length > 0) {
        $.ajax({
          url: "Modele/Planification.php",
          method: "POST",
          data: {
            idSprint: $('#numeroSprint').val(),
            idEmploye: $('#TOUTLEMONDE').val(),
            NombreHeure: $('#nbheure2').val(),
            idTypeTache: parseInt($('#RemplirTypeTache1').val()),
            action: "AttributionScrumPlaning"
          },
          success: function (data) {
            BootstrapAlertDefaut(data);
            // $('#ModalTache').modal('hide');
            RemplirTableau('TableListHeuresAttribuees');
            RemplirTableauRessources('TableListHeuresAttribueesRessources');
            RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
          }
        });
      }
      else
        BootstrapAlertError('Aucune ressource selectionnée ?')
    });

    //Créer démo
    $(document).on('click', '.EnvoyerDemo', function () {

      $.ajax({
        url: "Modele/Demo.php",
        method: "POST",
        data: {
          idEmploye: $('#TypeEmployeOk').val(),
          idProjet: $('#projetId').val(),
          LabelDemo: $('#LabelDemo').val(),
          action: "CréerDemo"
        },
        success: function (data) {
          BootstrapAlertDefaut(data);
        }
      });
      $('#LabelDemo').val('');
    });

    //Créer objectif
    $(document).on('click', '.EnvoyerObjectif', function () {

      $.ajax({
        url: "Modele/Retrospective.php",
        method: "POST",
        data: {
          idSprint: $('#numeroSprint').val(),
          LabelObjectif: $('#LabelObjectif').val(),
          idEmploye: $('#TypeEmployeOk').val(),
          idProjet: $('#projetId').val(),
          action: "Créer"
        },
        success: function (data) {
          BootstrapAlertDefaut(data);
        }
      });
      $('#LabelObjectif').val('');
    });

    // Selectionner ou déselectionner tout le monde
    $("#CheckAll").click(function () {
      if ($("#CheckAll").is(':checked')) {
        $("#TOUTLEMONDE > option").prop("selected", "selected");
        $("#TOUTLEMONDE").trigger("change");
      } else {
        $("#TOUTLEMONDE > option").prop("selected", "");
        $("#TOUTLEMONDE").trigger("change");
      }
    });

    $('#ChercherApiPivotal').click(function () {

      $('#EnvoyerApiPivotal').hide()

      var htmlDeFin = ""
      var ListeErreur = ""

      document.getElementById('ListeTachesApi').innerHTML = ""

      var myStories

      console.log('🎁 Projet: ' + $("#ProjetApi option:selected").text())

      ////////////////////////////////// Requette qui récupère toutes les stories d'une ressource sur le projet sélectionné
      $.ajax({
        url: "https://www.pivotaltracker.com/services/v5/projects/" + $('#ProjetApi').val().split('|')[1] + "/stories",
        beforeSend: function (xhr) {
          xhr.setRequestHeader('X-TrackerToken', TokenApi);
        },
        type: 'GET',
        dataType: 'json',
        contentType: 'application/json',
        processData: false,
        data: 'filter=mywork:' + $('#RessourceApi').val().split('|')[1],
        error: function (XMLHttpRequest, textStatus, errorThrown) {
          BootstrapAlertError("Le projet n'a pas d'API Pivotal Tracker enregistré");
        },
        success: function (data) {

          //Liste des stories trouvées
          myStories = data;

          ////////////////////////////////////////// Pour chaques stories trouvé, sortir chaque taches
          $.each(myStories, function () {

            Storyname = this.name
            StoryId = this.id

            $.ajax({
              url: "https://www.pivotaltracker.com/services/v5/projects/" + $('#ProjetApi').val().split('|')[1] + "/stories/" + this.id + "/tasks",
              beforeSend: function (xhr) {
                xhr.setRequestHeader('X-TrackerToken', TokenApi);
              },
              async: false,
              type: 'GET',
              dataType: 'json',
              contentType: 'application/json',
              processData: false,
              success: function (LesTaches) {

                if (LesTaches.length != 0) {
                  console.log('   📙 Storie: ' + Storyname)
                  // htmlDeFin += '<div  style="margin-bottom: 30px;"> <h3>' + Storyname + '</h3>'
                  htmlDeFin += '<table class="table table-sm thead-dark table-bordered"><tbody class="thead-dark"><tr><th colspan="10">'+ Storyname + '</th></tr>';

                  $.each(LesTaches, function () {
                    try {
                      var ListeHeures = /\.-(.+)/.exec(this.description)[1];
                      console.log('       📃 Une tache à faire : ' + this.description)
                    } catch  {
                      console.log("       🔴🔴🔴🔴" + this.description)
                      ListeErreur = this.description
                    }

                    var RegexGroupeHeure = /([0-9]+)/g
                    var InputHeure = '<tr><td class=Tache' + this.complete + '><select onchange="TotalHoursChecked()"><option value="NON">NON</option>'

                    match = RegexGroupeHeure.exec(ListeHeures);
                    while (match != null) {
                      InputHeure += '<option value=' + match[0] + '>' + match[0] + '</option>'
                      match = RegexGroupeHeure.exec(ListeHeures);
                    }
                    InputHeure += '</select>'

                    htmlDeFin += InputHeure + ' ' + this.description + '</td></tr>'
                  })
                  htmlDeFin += "</tbody></table>"
                }
                document.getElementById("ListeTachesApi").innerHTML = htmlDeFin
              }
            });
          })



          //si pas de stories
          if (htmlDeFin === '') {
            document.getElementById("ListeTachesApi").innerHTML = "<h3>Aucunes storie pour ce projet ?</h3><label>Si vous êtes sûr du contraire, le problème peut provenir de différentes raisons\
        <ul>\
          <li>La ressource n'est pas owner des stories ? </li>\
          <li>L'ID pivotal tracker du projet ou de la ressource n'est pas le bon ?</li>\
        </ul>\
      </label>"
          }
          else {
            $('#EnvoyerApiPivotal').show()
          }


        }
      });

    })

    $('#EnvoyerApiPivotal').click(function () {
      if (TotalHoursChecked().length > 2)
        $.ajax({
          url: "Modele/Planification.php",
          method: "POST",
          data: {
            action: "CreerTacheApi",
            ListeTaches: TotalHoursChecked(),
            Sprint: $('#numeroSprint').val(),
            Employe: $('#RessourceApi').val().split('|')[0],
            Projet: $('#ProjetApi').val().split('|')[0]
          },
          success: function (data) {
            RemplirTableau('TableListHeuresAttribuees');
            RemplirTableauRessources('TableListHeuresAttribueesRessources');
            RemplirTableauProjets('TableauListeHeuresAttrbueesProjets');
            BootstrapAlertDefaut(data);
            document.getElementById("ListeTachesApi").innerHTML = ""
            HeureAttribuable1Ressource();
            $('#EnvoyerApiPivotal').hide()
          }
        });

      else
        BootstrapAlertError('Aucune tâche sélectionnée');
    })

    SetSelect2('#TypeEmployeOk, #projetId, #RessourceApi, #ProjetApi, #TOUTLEMONDE');
  });

  function TotalHoursChecked() {

    var cart = [];
    var TotalHeures = 0;

    cart.push({
      'User': $('#RessourceApi').val().split('|')[0]
    });

    cart.push({
      'Project': $('#ProjetApi').val().split('|')[0]
    });

    $('tr td select').each(function () {

      if (this.value != "NON") {
        TotalHeures += parseInt(this.value);

        element = {}
        element.heure = parseInt(this.value);
        element.label = /(.+)\.-/.exec($(this).parent()[0].innerText)[1].trim();
        if ($(this).parent()[0].className == "Tachetrue")
          element.done = DateFrToEn(ChoixDate(0))
        else
          element.done = null
        cart.push(element)
      }

    })
    document.getElementById("totalheure").innerHTML = "Heures planifiables : " + ($('#TotalHeureAttribuable').val() - TotalHeures) + "h"

    return cart
  }
</script>