<script src="https://apis.google.com/js/api.js"></script>

<body class="fixed-nav sticky-footer" id="page-top">
  <div class="content-wrapper">
    <div class="container-fluid">

      <div class="row">
        <div class="col">
          <div id="ListSrint"></div>
        </div>
        <div class="col">
          <button type="button" id="Boutton_Modal_ApiPivotal" class="btn btn-block btn-info">Planification</button>
        </div>
        <div class="col">
          <button type="button" id="ButtonScrumPlaning" class="btn btn-block btn-info"
            onclick="$('#ModalScrumPlaning').modal('show');">Scrum planning </button>
        </div>
        <div class="col">
          <button type="button" id="Btn_Modal_Objectif_Demo" class="btn btn-block btn-info"
            onclick="$('#Modal_Objectif_Demo').modal('show');">Objectif / Démo</button>
        </div>
        <div class="col">
          <button type="button" id="Btn_Modal_Google_Calendar" class="btn btn-block btn-info"
            onclick="$('#ModalGoogleCalendar').modal('show');">Réunion</button>
        </div>

      </div>
      <div class="row">
        <div class="col-lg-7">
          <input class="form-control" id="BarreDeRecherche" type="text" placeholder="Rechercher..">
        </div>
      </div>
      <div class="row">
        <div class="col-lg-7">

          <div id="TableListHeuresAttribuees" class="table-responsive table-hover"></div>

        </div>

        <div class="col-lg-3">

          <div id="TableListHeuresAttribueesRessources" class="table-responsive table-hover">
          </div>
        </div>
        <div class="col-lg-2">
          <div id="TableauListeHeuresAttrbueesProjets" class="table-responsive table-hover">
          </div>

        </div>
      </div>
    </div>
</body>


<div id="Modal_Objectif_Demo" class="modal fade">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body">

        <div class="row">
          <div class="col-lg-6">
            <label>Ressource</label>
            <div id="ListEmploye"> </div>
          </div>

          <div class="col-lg-6">
            <label>Projet</label>
            <div id="ListProjet"></div>
          </div>
        </div>

        <p></p>
        <hr>
        <p></p>

        <div class="row">

          <div class="row col-lg-12">
            <h5>&nbsp;&nbsp; Objectifs</h5>
          </div>
          <div class="col-lg-9">
            <textarea class="form-control" placeholder="Label objectif" name="LabelObjectif" id="LabelObjectif"
              rows="2"></textarea>

          </div>

          <div class="col-lg-3">
            <input type="submit" value="Attribuer" class="btn btn-success EnvoyerObjectif" />
          </div>
        </div>

        <p></p>

        <div class="row">
          <div class="row col-lg-12">
            <h5>&nbsp;&nbsp; Démo</h5>
          </div>
          <div class="col-lg-9">
            <input class="form-control" name="LabelDemo" id="LabelDemo" type="text" placeholder="Label démo">
          </div>

          <div class="col-lg-3">
            <input type="submit" value="Attribuer" class="btn btn-success EnvoyerDemo" />
          </div>
        </div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<div id="ModalApi" class="modal fade">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-6">
            <label>Ressource</label>
            <div id="ListEmployePivotal"> </div>
          </div>

          <div class="col-lg-6">
            <label>Projet</label>
            <div id="ListProjetPivotal"></div>
          </div>
        </div>
        <p></p>

        <div class="row">
          <div class="row col-lg-12">
            <h5>&nbsp;&nbsp; Planification manuelle</h5>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-9">
            <input class="form-control" name="nbheure" id="nbheure" type="text" placeholder="x+x+x">
          </div>

          <div class="col-lg-3">
            <input type="hidden" name="id" id="id" />
            <input type="submit" name="action" id="action" class="btn btn-success" value="Attribuer" />
          </div>
        </div>

        <p></p>

        <div class="row">
          <div class="row col-lg-12">
            <h5>&nbsp;&nbsp; Pivotal Tracker</h5>
          </div>
        </div>
        <div class="row">
          <div class="col-lg-3">
            <button id="ChercherApiPivotal" class="btn btn-block btn-info">Rechercher</button>
          </div>
        </div>

        <input type="hidden" name="TotalHeureAttribuable" id="TotalHeureAttribuable" />

        <div class="FollowAttribuable">
          <div id="totalheure"></div>
          <button type="submit" id="EnvoyerApiPivotal" class="btn btn-block btn-success">Attribuer</button>
        </div>
        <p></p>
        <div id="AucuneStorie" class="hideElement">
          <h3>Aucunes storie pour ce projet ?</h3>
          <label>
            Si vous êtes sûr du contraire, le problème peut provenir de différentes raisons
            <ul>
              <li>La ressource n'est pas owner des stories ? </li>
              <li>L'ID pivotal tracker du projet ou de la ressource n'est pas le bon ?</li>
            </ul>
          </label>
        </div>
        <div id="ListeTachesApi"></div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<div id="ModalScrumPlaning" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">

        <div class="form-group">
          <label>Ressources</label>
          <div id="ListEmployeCheckBox"></div>
          <input type="checkbox" id="CheckAll">Tout le monde
        </div>

        <div class="form-group">
          <label>Type de tâche</label>
          <div id="ListTypeTache"></div>
        </div>

        <div class="form-group">
          <label>Nombre d'heures</label>
          <input class="form-control" name="nbheure2" id="nbheure2" type="number" min="1" value="1">
        </div>

      </div>
      <div class="modal-footer">
        <input type="hidden" name="id" id="id" />
        <input type="submit" class="btn btn-success AttribuerHeureScrumPlaning" />
        <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<div id="ModalGoogleCalendar" class="modal fade">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-body">
        <div class="row">
          <div class="col-lg-4">
            <button class="btn btn-block btn-primary" onclick="authenticate().then(loadClient)">Autoriser</button>
          </div>
          <div class="col-lg-4">
            <button type="button" class="btn btn-block btn-primary" id="SearchCalendarEvent" onclick="execute()"
              disabled>Charger</button>
          </div>
          <div class="col-lg-4">
            <button type="button" class="btn btn-block btn-primary" id="EnvoyerEventBdd"
              disabled>Envoyer</button>
          </div>
        </div>
        <p></p>
        <div class="row">
          <!-- <div class="col-lg-12">
            <div id="DivListMail"></div>
          </div> -->
        </div>
        <p></p>
        <u>
          <div class="centered" id="InfoDateSprint"></div>
        </u>
        <p></p>

        <div id="ListReunion"></div>

      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<div id="ModalGestionHeuresDescendues" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title"></h4>
      </div>
      <div class="modal-body">

        <div class="form-group">
          <label>Ressource</label>
          <div id="ListEmployeEditionTache"></div>
        </div>

        <div class="form-group">
          <label>Projet</label>
          <div id="ListProjetEditionTache"></div>
        </div>

        <div class="form-group">
          <label>Nombre heures</label>
          <input class="form-control" name="nbheureEditionTache" id="nbheureEditionTache" type="number" min="1"
            value="1">
        </div>

        <div class="form-group">
          <label>Label</label>
          <input class="form-control" name="LabelTache" id="LabelTache" type="text">
        </div>

        <div class="form-group">
          <label>Date</label>
          <input type="text" name="Done" id='Done' class="form-control" />
        </div>

      </div>

      <div class="modal-footer">
        <input type="hidden" name="id" id="id" />
        <input type="submit" name="actionEditionTache" id="actionEditionTache" class="btn btn-success"
          value="Mettre à jour" />
        <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {

    RequeteAjax('ListSrint', 'ListeDeroulanteSprint', 'Modele/RequetesAjax.php');
    RequeteAjax('ListEmploye', 'ListeDeroulanteEmployeActif', 'Modele/RequetesAjax.php',
    'ListeEmployeObjectifDemo');
    RequeteAjax('ListEmployeEditionTache', 'ListeDeroulanteEmployeActif', 'Modele/RequetesAjax.php',
      'ListeEmployeEditionTache');
    RequeteAjax('ListProjet', 'ListeDeroulanteProjet', 'Modele/RequetesAjax.php', 'ListeProjetObjectifDemo');
    RequeteAjax('ListProjetEditionTache', 'ListeDeroulanteProjet', 'Modele/RequetesAjax.php',
      'ListeProjeteditionTache');
    RequeteAjax('ListEmployePivotal', 'RessourcePivotal', 'Modele/RequetesAjax.php');
    RequeteAjax('ListProjetPivotal', 'ProjetPivotal', 'Modele/RequetesAjax.php');
    RequeteAjax('ListTypeTache', 'RemplirTypeTache', 'Modele/RequetesAjax.php');
    RequeteAjax('ListEmployeCheckBox', 'ListEmployeCheckBox', 'Modele/RequetesAjax.php');
    // RequeteAjax('DivListMail', 'ListeDeroulanteEmployeMail', 'Modele/RequetesAjax.php', 'ListMailRessource');

    $("#ListeProjetObjectifDemo, #ListeEmployeObjectifDemo, #TOUTLEMONDE, #RessourceApi, #ProjetApi, #ListMailRessource")
      .select2({
        width: "100%"
      });

    $('#Done').datetimepicker({
      format: 'dd-mm-yyyy',
      autoclose: true,
      minView: 2,
      weekStart: 1
    });

    RemplirTableau('TableListHeuresAttribuees');
    RemplirTableauRessources('TableListHeuresAttribueesRessources');
    RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')

    BarreDeRecherche('BarreDeRecherche', 'TableListHeuresAttribuees');

    //Lorsque charge la liste, si le projet est pas dans pivotal tracker, disable le chercher
    if ($('#ProjetApi').val().split('|')[1] == "")
      $('#ChercherApiPivotal').prop('disabled', true);
    else
      $('#ChercherApiPivotal').prop('disabled', false);

    //Remplir le tableu avec toutes les tâches de tout le monde
    function RemplirTableau(Div) {
      $.ajax({
        url: "Modele/Planification.php",
        method: "POST",
        data: {
          action: "RemplirTableau",
          idAffiche: $('#numeroSprint').val()
        },
        success: function (data) {
          $('#' + Div).html(data);
          GarderLaRecherche('BarreDeRecherche', 'TableListHeuresAttribuees');
        }
      });
    }

    //Remplir le tableau avec toutes les ressources qui ont des heures planifiés
    function RemplirTableauRessources(Div) {
      $.ajax({
        url: "Modele/Planification.php",
        method: "POST",
        data: {
          action: "RemplirTableauRessources",
          idAffiche: $('#numeroSprint').val()
        },
        success: function (data) {
          $('#' + Div).html(data);
        }
      });
    }

    //Remplir tableau avec tous les projets, pas de id pivotal
    function RemplirTableauProjets(Div) {
      $.ajax({
        url: "Modele/Planification.php",
        method: "POST",
        data: {
          action: "RemplirTableauProjets",
          idAffiche: $('#numeroSprint').val()
        },
        success: function (data) {
          $('#' + Div).html(data);
        }
      });
    }

    //Petite infos quand planifie qui indique combiens d'heures encore planifiables
    function HeureAttribuable1Ressource() {
      $.ajax({
        url: "Modele/Planification.php",
        method: "POST",
        data: {
          action: "NbHeureRestantePlanifiable",
          Sprint: $('#numeroSprint').val(),
          Employe: $('#RessourceApi').val().split('|')[0]
        },
        dataType: "json",
        success: function (data) {
          $('#TotalHeureAttribuable').val(data.Attribuable);
          document.getElementById("totalheure").innerHTML = "Heures planifiables : " + data.Attribuable + "h"
        }
      });
    }

    //Si le numéro de sprint change, tout recharger
    $('#numeroSprint').change(function () {
      RemplirTableau('TableListHeuresAttribuees');
      RemplirTableauRessources('TableListHeuresAttribueesRessources');
      RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
    });

    //delete une tache sur le bouton de delete
    $(document).on('click', '.delete', function () {
      if (confirm("Es-tu sûr de vouloir supprimer cette tâche ?"))
        $.ajax({
          url: "Modele/GestionTache.php",
          method: "POST",
          data: {
            id: $(this).attr("id"),
            action: "Delete"
          },
          success: function (data) {
            RemplirTableau('TableListHeuresAttribuees');
            RemplirTableauRessources('TableListHeuresAttribueesRessources');
            RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
            $.notify(data, "success");
          }
        })
    });

    //Remplie le modal avec les infos de la tache a éditer
    $(document).on('click', '.update', function () {
      var id = $(this).attr("id");
      var action = "Select";
      $.ajax({
        url: "Modele/GestionTache.php",
        method: "POST",
        data: {
          id: id,
          action: action
        },
        dataType: "json",
        success: function (data) {
          $('#ModalGestionHeuresDescendues').modal('show');
          $('.modal-title').text("Metre à jour les heures descendues");
          $('#id').val(id);
          $('#idSprint').val(data.id_Sprint);
          $('#ListeEmployeEditionTache').val(data.id_Employe);
          $('#ListeProjeteditionTache').val(data.id_Projet);
          $('#nbheureEditionTache').val(data.heure);
          $('#LabelTache').val(data.Label);
          $('#Done').val(data.Done);

          $("#ListeEmployeEditionTache, #ListeProjeteditionTache").select2({
            width: "100%"
          });
        }
      });
    });

    //Maj de la tache envoyée au back
    $('#actionEditionTache').click(function () {
      $.ajax({
        url: "Modele/GestionTache.php",
        method: "POST",
        data: {
          id: $('#id').val(),
          Done: DateFrToEn($('#Done').val()),
          idSprint: $('#numeroSprint').val(),
          idEmploye: $('#ListeEmployeEditionTache').val(),
          idProjet: $('#ListeProjeteditionTache').val(),
          NombreHeure: $('#nbheureEditionTache').val(),
          Label: $('#LabelTache').val(),
          action: "Update"
        },
        success: function (data) {
          $.notify(data, "success");
          $('#ModalGestionHeuresDescendues').modal('hide');
          RemplirTableau('TableListHeuresAttribuees');
          RemplirTableauRessources('TableListHeuresAttribueesRessources');
          RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
        }
      });
    });

    //Si change liste projet, checker si pivotal ou non et donc disable ou non bouton
    $('#ListProjetPivotal').change(function () {
      if ($('#ProjetApi').val().split('|')[1] == "")
        $('#ChercherApiPivotal').prop('disabled', true);
      else
        $('#ChercherApiPivotal').prop('disabled', false);
    });

    //Si change ressource api, remettre le compteur d'heure attribuable flotant au bon nombre
    $('#RessourceApi').change(function () {
      HeureAttribuable1Ressource();
    });

    //Click sur le bouton pour planifier des heures
    $('#Boutton_Modal_ApiPivotal').click(function () {
      HeureAttribuable1Ressource();
      document.getElementById("ListeTachesApi").innerHTML = ""
      $('#ModalApi').modal('show');
      $('#EnvoyerApiPivotal').hide()
    });

    //Planifier des heures selon le mode x+x+x
    $('#action').click(function () {
      var erreur = false

      if ($('#nbheure').attr('type') == 'text') {
        var NombreHeure = $('#nbheure').val().split('+').map(function (item) {
          return parseInt(item);
        });

        NombreHeure.forEach(function (element) {
          if (isNaN(element))
            erreur = true
        });
      } else
        var NombreHeure = $('#nbheure').val()

      if (erreur == false) {

        $.ajax({
          url: "Modele/Planification.php",
          method: "POST",
          data: {
            id: $('#id').val(),
            idSprint: $('#numeroSprint').val(),
            idEmploye: $('#RessourceApi').val().split('|')[0],
            idProjet: $('#ProjetApi').val().split('|')[0],
            NombreHeure: NombreHeure,
            action: "Attribuer"
          },
          success: function (data) {
            $.notify(data, "success");
            // $('#Modal_Objectif_Demo').modal('hide');
            RemplirTableau('TableListHeuresAttribuees');
            RemplirTableauRessources('TableListHeuresAttribueesRessources');
            RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
            HeureAttribuable1Ressource()
          }
        });

        $('#nbheure').val('');
      } else $.notify("Le champ d'heure comporte une erreur", "error");

    });

    //Planifier des heures spéciales scrum planing
    $(document).on('click', '.AttribuerHeureScrumPlaning', function () {

      if ($('#TOUTLEMONDE').length > 0) {
        $.ajax({
          url: "Modele/Planification.php",
          method: "POST",
          data: {
            idSprint: $('#numeroSprint').val(),
            idEmploye: $('#TOUTLEMONDE').val(),
            NombreHeure: $('#nbheure2').val(),
            idTypeTache: parseInt($('#RemplirTypeTache1').val()),
            action: "AttributionScrumPlaning"
          },
          success: function (data) {
            $.notify(data, "success");
            // $('#Modal_Objectif_Demo').modal('hide');
            RemplirTableau('TableListHeuresAttribuees');
            RemplirTableauRessources('TableListHeuresAttribueesRessources');
            RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
          }
        });
      } else
        $.notify("Aucune ressource selectionnée ?", "error");
    });

    //Créer des démos
    $(document).on('click', '.EnvoyerDemo', function () {

      $.ajax({
        url: "Modele/Demo.php",
        method: "POST",
        data: {
          idEmploye: $('#ListeEmployeObjectifDemo').val(),
          idProjet: $('#ListeProjetObjectifDemo').val(),
          LabelDemo: $('#LabelDemo').val(),
          action: "CréerDemo"
        },
        success: function (data) {
          $.notify(data, "success");
        }
      });
      $('#LabelDemo').val('');
    });

    //Créer des objectifs
    $(document).on('click', '.EnvoyerObjectif', function () {

      $.ajax({
        url: "Modele/Retrospective.php",
        method: "POST",
        data: {
          idSprint: $('#numeroSprint').val(),
          LabelObjectif: $('#LabelObjectif').val(),
          idEmploye: $('#ListeEmployeObjectifDemo').val(),
          idProjet: $('#ListeProjetObjectifDemo').val(),
          action: "Créer"
        },
        success: function (data) {
          $.notify(data, "success");
        }
      });
      $('#LabelObjectif').val('');
    });

    // Selectionner ou déselectionner tout le monde
    $("#CheckAll").click(function () {
      if ($("#CheckAll").is(':checked')) {
        $("#TOUTLEMONDE > option").prop("selected", "selected");
        $("#TOUTLEMONDE").trigger("change");
      } else {
        $("#TOUTLEMONDE > option").prop("selected", "");
        $("#TOUTLEMONDE").trigger("change");
      }
    });

    //Click sur le bouton pour chercher toutes les heures planifiable sur pivotal tracker
    $('#ChercherApiPivotal').click(function () {

      $("#ChercherApiPivotal").attr("disabled", true).text('Recherche en cours.. ').append('<span id="logochargement" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');

      document.getElementById("ListeTachesApi").innerHTML = ""
      $('#AucuneStorie').addClass('hideElement')

      $('#EnvoyerApiPivotal').hide()

      var htmlDeFin = ""

      // var test1 = new Array();
      var myStories

      console.log('🎁 Projet: ' + $("#ProjetApi option:selected").text())

      ////////////////////////////////// Requette qui récupère toutes les stories d'une ressource sur le projet sélectionné
      $.ajax({
        url: "https://www.pivotaltracker.com/services/v5/projects/" + $('#ProjetApi').val().split('|')[1] +
          "/stories",
        beforeSend: function (xhr) {
          xhr.setRequestHeader('X-TrackerToken', 'b4a752782f711a7c564221c2b0c2d5dc');
        },
        type: 'GET',
        dataType: 'json',
        contentType: 'application/json',
        processData: false,
        data: 'filter=mywork:' + $('#RessourceApi').val().split('|')[1],
        error: function (XMLHttpRequest, textStatus, errorThrown) {
          $.notify("Le projet n'a pas d'API Pivotal Tracker enregistrée.", "error");
        },
        success: function (data) {
          //Liste des stories trouvées
          myStories = data;

          ////////////////////////////////////////// Pour chaques stories trouvé, sortir chaque taches
          $.each(myStories, function () {

            Storyname = this.name
            StoryId = this.id
            Storyurl = this.url

            $.ajax({
              url: "https://www.pivotaltracker.com/services/v5/projects/" + $('#ProjetApi').val()
                .split('|')[1] + "/stories/" + this.id + "/tasks",
              beforeSend: function (xhr) {
                xhr.setRequestHeader('X-TrackerToken', 'b4a752782f711a7c564221c2b0c2d5dc');
              },
              async: false,
              type: 'GET',
              dataType: 'json',
              contentType: 'application/json',
              processData: false,
              success: function (LesTaches) {

                // var test2 = new Array();
                // var test3 = new Array();

                // test2.push(Storyname) 
                // test1.push(test2) 
                console.log('   📙 Storie: ' + Storyname)
                htmlDeFin +=
                  '<table class="table table-sm thead-dark table-bordered"><tbody class="thead-dark"><tr><th colspan="10"><u><a class="HeaderTablePlanif" href=' +
                  Storyurl + '>' + Storyname + '</a></u> 🔗</th></tr>';

                $.each(LesTaches, function () {
                  // var test4 = new Array();
                  // var test5 = new Array();
                  try {
                    var ListeHeures = /\.-(.+)/.exec(this.description)[1];
                    // test4.push(this.description)
                    console.log('       📃 Une tache à faire : ' + this.description)
                  } catch {
                    console.log("       🔴🔴🔴🔴" + this.description)
                  }

                  var RegexGroupeHeure = /([0-9]+)/g
                  var InputHeure = '<tr><td class=Tache' + this.complete +
                    '><select id="LeSelectId" onchange="TotalHoursChecked()"><option value="NON">NON</option>'

                  match = RegexGroupeHeure.exec(ListeHeures);
                  while (match != null) {
                    // test5.push(match[0])
                    InputHeure += '<option value=' + match[0] + '>' + match[0] + '</option>'
                    match = RegexGroupeHeure.exec(ListeHeures);
                  }
                  // test4.push(test5)
                  // test3.push(test4)
                  InputHeure += '</select>'
                  htmlDeFin += InputHeure + ' <span id="TaskDescription">' + this
                    .description + '</span><span id="StoryId" class="hideElement">' +
                    StoryId + '</span><span id="TaskId" class="hideElement">' + this.id +
                    '</span></td></tr>'
                })
                // test2.push(test3)
                htmlDeFin += "</tbody></table>"

                document.getElementById("ListeTachesApi").innerHTML = htmlDeFin
              }
            });
          })

          $("#ChercherApiPivotal").attr("disabled", false).text('Rechercher');

          //si pas de stories
          if (myStories.length === 0) {
            $('#AucuneStorie').removeClass('hideElement')
          } else {
            $('#EnvoyerApiPivotal').show()
          }
          // console.log('array sort: ',test1.sort())
        }
      });
    })

    //Click sur le bouton flottant vert attribuer des heures planifiées pivotal
    $('#EnvoyerApiPivotal').click(function () {
      if (TotalHoursChecked().length > 2)
        $.ajax({
          url: "Modele/Planification.php",
          method: "POST",
          data: {
            action: "CreerTacheApi",
            ListeTaches: TotalHoursChecked(),
            Sprint: $('#numeroSprint').val(),
            Employe: $('#RessourceApi').val().split('|')[0],
            Projet: $('#ProjetApi').val().split('|')[0]
          },
          success: function (data) {
            RemplirTableau('TableListHeuresAttribuees');
            RemplirTableauRessources('TableListHeuresAttribueesRessources');
            RemplirTableauProjets('TableauListeHeuresAttrbueesProjets');
            $.notify(data, "success");
            document.getElementById("ListeTachesApi").innerHTML = ""
            HeureAttribuable1Ressource();
            $('#EnvoyerApiPivotal').hide()
          }
        });

      else
        $.notify("Aucune tâche n'est sélectionnée", "error");
    })

    
    $('#EnvoyerEventBdd').click(function () {
    var counter = 0
    console.log(LaVariable)

    LaVariable.forEach(function (element) {

          $.ajax({
          url: "Modele/Planification.php",
          method: "POST",
          async: "false",
          data: {
            idSprint: $('#numeroSprint').val(),
            mailEmploye: element.email,
            NombreHeure: element.Temps,
            Label: element.Event,
            action: "AttribuerReunion"
          },
          success: function (data) {  
            counter += 1       
          }
        });

        });
          console.log('le compteur: '+counter)
          $.notify(LaVariable.length+ ' tâches de réunions ajoutées', "success");
          // location.reload();

          // $('#Modal_Objectif_Demo').modal('hide');
          RemplirTableau('TableListHeuresAttribuees');
          RemplirTableauRessources('TableListHeuresAttribueesRessources');
          RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')

  })

  });

  //Lorsque click sur le bouton flottant vert attribuer des heures planifiées pivotal, liste toutes les taches qui ne sont pas des "non" et les mettres dans un tableau qui sera envoyé
  function TotalHoursChecked() {

    var cart = [];
    var TotalHeures = 0;

    cart.push({
      'User': $('#RessourceApi').val().split('|')[0]
    });

    cart.push({
      'Project': $('#ProjetApi').val().split('|')[0]
    });

    $('#ListeTachesApi tr td').each(function () {


      if ($(this).children()[0].value != "NON") {
        TotalHeures += parseInt($(this).children('#LeSelectId')[0].options[$(this).children('#LeSelectId')[0]
          .selectedIndex].value);

        element = {}
        element.StoryId = $(this).children('#StoryId').text()
        element.TaskId = $(this).children('#TaskId').text()
        element.ProjectId = $('#ProjetApi').val().split('|')[1]
        element.heure = parseInt($(this).children('#LeSelectId')[0].options[$(this).children('#LeSelectId')[0]
          .selectedIndex].value)
        element.label = /(.+)\.-/.exec($(this).children('#TaskDescription').text())[1].trim();
        element.StoryLabel = ($(this).parent().parent().children()[0].innerText).slice(0, -3)

        if ($(this).hasClass('Tachetrue'))
          element.done = DateFrToEn(ChoixDate(0))
        else
          element.done = null

        cart.push(element)
      }

    })
    document.getElementById("totalheure").innerHTML = "Heures planifiables : " + ($('#TotalHeureAttribuable').val() -
      TotalHeures) + "h"

    return cart
  }

  function authenticate() {
    return gapi.auth2.getAuthInstance()
      .signIn({
        scope: "https://www.googleapis.com/auth/calendar https://www.googleapis.com/auth/calendar.events https://www.googleapis.com/auth/calendar.events.readonly https://www.googleapis.com/auth/calendar.readonly"
      })
      .then(function () {
          console.log("Sign-in successful");
        },
        function (err) {
          console.error("Error signing in", err);
        });
  }

  function loadClient() {
    gapi.client.setApiKey("AIzaSyBMEPLt4APiX1FrwAZ-yTFVXusUBWhhwD0");
    return gapi.client.load("https://content.googleapis.com/discovery/v1/apis/calendar/v3/rest")
      .then(function () {
          console.log("GAPI client loaded for API");
          $('#SearchCalendarEvent').removeAttr("disabled");
        },
        function (err) {
          console.error("Error loading GAPI client for API", err);
        });
  }

  var LaVariable = []
                
  // Make sure the client is loaded and sign-in is complete before calling this method.
  function execute() {

    $('#EnvoyerEventBdd').removeAttr("disabled");

    var DateMinSprint = "";
    var DateMaxSprint = "";

    $.ajax({
      url: "Modele/Tache.php",
      method: "POST",
      async: "false",
      data: {
        action: "DateMinMax",
        idAffiche: $('#numeroSprint').val()
      },
      success: function (data) {
        DateMinSprint = DateFrToEn(data.DateMin[0])
        DateMaxSprint = DateFrToEn(data.DateMax[0])

        $('#InfoDateSprint').html('Sprint du ' + data.DateMin[0] + ' au ' + data.DateMax[0])
      }
    }).then(function (response) {


      return gapi.client.calendar.events.list({
          "calendarId": "vm4sgd63mstfudh51c5k4h1n9o@group.calendar.google.com",
          "maxResults": 2500,
          "orderBy": "startTime",
          "showHiddenInvitations": true,
          "singleEvents": true,
          "timeMin": DateMinSprint + "T07:00:00+02:00",
          "timeMax": DateMaxSprint + "T23:00:00+02:00"
        })
        .then(function (response) {
            // console.log("Response", response);
            $('#ListReunion').html('')

            var idEvent = []

            $(response.result.items).each(function () {

              //Si il a des gens qui doivent participer et que ce n'est pas un doublon (event déjà logger précédement)
              if (this.attendees != null && !idEvent.includes(this.etag)) {

                //Si sur plusieurs jours, on passe
                if(this.start.date){
                  return;
                }

                //on ajout l'event a la list devent qu'on check pour pas le rechecker apres
                idEvent.push(this.etag)

                //Log l'event
                var LienEvent = this.htmlLink

                var DescriptionEvent = ''
                if (this.description) {
                  DescriptionEvent = this.description
                }

                var TempsCalendar = 0
                
                var DateCalendar = DateFrToEn(this.end.dateTime.substring(0,10))

                  // console.log(this.start.dateTime.substring(11,16))
                  // console.log(this.end.dateTime.substring(11,16))
                  // console.log(this.end.dateTime.substring(11,13)-this.start.dateTime.substring(11,13))
                  // console.log(this.end.dateTime.substring(14,16)-this.start.dateTime.substring(14,16))

                TempsCalendar = this.end.dateTime.substring(11,13)-this.start.dateTime.substring(11,13)
                if(this.end.dateTime.substring(14,16)-this.start.dateTime.substring(14,16) > 30){
                    TempsCalendar = TempsCalendar + 1
                }

                $('#ListReunion').append(`<div class="card" style="margin-bottom: 15px; border-color: black;">
                                      <div style="margin-left:4px;"><b><a href="` + LienEvent + `">`+DateCalendar+` `+TempsCalendar+`h | <span id="TitreEvent">`+this.summary +`</span></a></b>
                                      </div>
                                   </div>`)
               
                var theEvent = this

                //Alors pour chaque participant
                $(this.attendees).each(function () {

                    LaVariable.push({'Event': theEvent.summary, 'Temps' : TempsCalendar, 'email' : this.email});
                    console.log('Pour: '+ this.email + "\nEvent: " + theEvent.summary+ "\nTemps: " + TempsCalendar)

                })
              }
            })

            if ($('#ListReunion').text() == "")
              $('#ListReunion').text('Aucune réunion de prévu pour ' + $("#ListMailRessource option:selected")
              .text() + '(' + $("#ListMailRessource option:selected").val() + ') pour le moment')
          },

          function (err) {
            console.error("Execute error", err);
          });
    })
  }
  gapi.load("client:auth2", function () {
    gapi.auth2.init({
      client_id: "140086684989-cbg9jgefb6gkc5cl37tmeu09mrc0m5ii.apps.googleusercontent.com"
    });
  });

</script>