<body class="fixed-nav sticky-footer" id="page-top">
  <div class="content-wrapper">
    <div class="container-fluid">

      <div class="centered border border-dark mb-3" onclick="$('#ModaleClient').modal('show'); ">
        <h2 class="centered mb-2" id="NomProjet"></h2>
        <h4 class="centered mb-4" id="ClientEntreprise"></h4>
        <h4 class="centered mb-3" id="DescriptionProjet"></h4>
      </div>

      <div class="border border-dark mb-3">
        <p class="ml-2 mt-1"><small>Ressoures mobilisées</small></p>
        <div id="RessourcesMobilisees" class="col row"></div>
      </div>

      <div class="border border-dark mb-3">
        <p class="ml-2 mt-1"><small>Technologies mobilisées</small></p>
        <div id="TechnologiesProjet" class="col row"></div>
      </div>

      <div class="border border-dark mb-3">
        <p class="ml-2 mt-1"><small>Échange réalisés</small></p>
        <button class="btn btn-info btn-sm ml-2 mb-2" id="ModaleAddEchange">Ajouter</button>
          <table class="table table-sm table-striped table-bordered">
            <thead>
              <tr>
                <th>Échange</th>
                <th>Date</th>
                <th>Type</th>
                <th>Édition</th>
              </tr>
            </thead>
            <tbody id="EchangesProjet">
              
            </tbody>
          </table>
            
      </div>

      <div class="border border-dark mb-3">
        <p class="ml-2 mt-1"><small>Note</small></p>
        <div class="col row ml-1 mb-2">
          <textarea class="form-control mb-2" id="Note" rows="3"></textarea>
          <button type="button" class="btn btn-success" id="putNote" data-dismiss="modal">Valider</button>
        </div>
      </div>

      <div class="border">
        <p><small>Timelinep</small></p>
        <div id="ProjectTimeLine" class="col row"></div>
      </div>

    </div>
  </div>
</body>

<div id="ModaleClient" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">

        <div class="form-group">
          <label>Entreprise</label>
          <input class="form-control" id="ClientEntrepriseModale" type="text">
        </div>

        <div class="form-group">
          <label>Nom</label>
          <input class="form-control" id="ClientNomModale" type="text">
        </div>

        <div class="form-group">
          <label>Poste</label>
          <input class="form-control" id="ClientJobModale" type="text">
        </div>

        <div class="form-group">
          <label>Mail</label>
          <input class="form-control" id="ClientMailModale" type="text">
        </div>

        <div class="form-group">
          <label>Téléphone</label>
          <input class="form-control" id="ClientTelephoneModale" type="text">
        </div>

        <input class="form-control" type="hidden" id="ClientID" type="text">

        <button type="button" class="btn btn-success" id="putClient" data-dismiss="modal">Editer</button>
        <button type="button" class="btn btn-dark" data-dismiss="modal">Fermer</button>

      </div>

    </div>
  </div>
</div>

<div id="ModaleAddUser" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <p>Ressources</p>

        <div id="ListEmployeCheckBox"></div>
        <button type="button" id="AddRessourceToProject" class="btn btn-info mt-2 btn-sm">Ajouter ressource(s)</button>
      </div>

    </div>
  </div>
</div>

<div id="ModaleTechno" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <p>Technologie</p>

        <input class="form-control" list="listTechnos" id="inputTechno"/>

        <datalist id="listTechnos">
            <option value="Ajax">
            <option value="Jquery">
            <option value="PHP">
            <option value="HTML">
            <option value="VueJs">
        </datalist>

        <button type="button" id="AddTechnoToProject" class="btn btn-info mb-1 btn-sm">Ajouter Techno</button>
      </div>

    </div>
  </div>
</div>

<div id="ModaleComment" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">
        <div class="col">

        <div class="form-group">
          <label>Échange</label>
          <textarea class="form-control" id="Echange_Label"
              rows="3"></textarea>

        </div>
        </div>

        <div class="col">
          <div class="form-group">
            <label>Date</label>
            <input type="text" class="form-control" id="Echange_Date">
          </div>
        </div>

        <div class="col">
          <div class="form-group">
            <label>Type</label>

            <input class="form-control" list="listEchangeType" id="Echange_Type"/>

            <datalist id="listEchangeType">
                <option value="Mail">
                <option value="Téléphone">
                <option value="Réunion">
                <option value="Entretiens">
            </datalist>

          </div>
        </div>
        <input type="number" class="form-control d-none" id="Echange_ID">

        <div class="col">
          <button type="button" id="AddEchange" class="btn btn-info mt-2 btn-block">Nouvel échange</button>
          <button type="button" id="EditEchange" class="btn btn-info mt-2 btn-block">Éditer échange</button>
        </div>

        
      </div>

    </div>
  </div>
</div>

<script>
  $(document).ready(function () {

    RequeteAjax('ListEmployeCheckBox', 'ListEmployeCheckBox', 'Modele/RequetesAjax.php');
    $("#TOUTLEMONDE").select2({
        width: "100%"
      });

    $('#Echange_Date').datetimepicker({format: 'dd/mm/yyyy', autoclose: true, minView: 2, weekStart: 1});

    var projectId = parseInt(location.href.split('projet=')[1])
    
    GetDescription()
    GetClient()
    GetRessources()
    GetTechnos()
    GetNote()
    GetEchanges()
    GetTimeLine()

    //+-+-+-+-+-+-+-+-+-+-+ Infos Projet +-+-+-+-+-+-+-+-+-+-+

    function GetDescription(){
    $.ajax({
      url: "Modele/ProjectInformation.php",
      method: "POST",
      data: {
        projectId: projectId,
        action: "getDescription"
      },
      dataType: "json",
      success: function (data) {
        $('#NomProjet').text(data.Nom);
        $('#DescriptionProjet').text(data.Description);
      }
    });
    }

    //+-+-+-+-+-+-+-+-+-+-+ Client +-+-+-+-+-+-+-+-+-+-+

    function GetClient(){
    $.ajax({
      url: "Modele/ProjectInformation.php",
      method: "POST",
      data: {
        projectId: projectId,
        action: "getClient"
      },
      dataType: "json",
      success: function (data) {

        if(data.logo == '' || data.logo == undefined || data.logo == null){ 
            data.logo = 'default'
        }

        $('#ClientEntreprise').text(data.entreprise);

        $('#ClientEntrepriseModale').val(data.entreprise);
        $('#ClientNomModale').val(data.Nom);
        $('#ClientJobModale').val(data.job);
        $('#ClientMailModale').val(data.mail);
        $('#ClientTelephoneModale').val(data.telephone);
        $('#ClientID').val(data.id);

      }
    });
  }

    $('#putClient').bind( "click", function() {

  $.ajax({
      url: "Modele/ProjectInformation.php",
      method: "POST",
      data: {
        client_id: document.getElementById('ClientID').value,
        client_entreprise: document.getElementById('ClientEntrepriseModale').value,
        client_nom: document.getElementById('ClientNomModale').value,
        client_job: document.getElementById('ClientJobModale').value,
        client_mail: document.getElementById('ClientMailModale').value,
        client_telephone: document.getElementById('ClientTelephoneModale').value,
        action: "putClient"
      },
      success: function (data) {
        Notify(data,'Client édité')
      }
    });

    $('#ModaleClient').modal('hide');

  });

  //+-+-+-+-+-+-+-+-+-+-+ Ressources +-+-+-+-+-+-+-+-+-+-+

    function GetRessources() {

    $('#RessourcesMobilisees').html('')

    $.ajax({
      url: "Modele/ProjectInformation.php",
      method: "POST",
      data: {
        projectId: projectId,
        action: "GetRessources"
      },
      dataType: "json",
      success: function (data) {

        $.each(data, function () {

          var divRessource = $(`<div class="ml-3"></div>`);

          if(this.Avatar == '' || this.Avatar == undefined || this.Avatar == null){ 
            this.Avatar = 'default.png'
          }

          divRessource.append($(`<img height="75px" width="75px" src="Assets/Image/Ressources/`+this.Avatar+`">`));
          divRessource.append($(`<img id="`+this.RessourceId+`" height="25px" width="25px" style="position: relative;left: -19px;top: -27px;" src="` + `Assets/Image/Autre/delete.png">`).bind( "click", function() {
            SuppRessource($(this))
          }));

          divRessource.append($(`<p class="mb-n1"><b>`+this.Prenom+`</b></p>`))
          divRessource.append($(`<p>`+this.Job+`</p>`))
          
          $('#RessourcesMobilisees').append(divRessource)
        
        })
        $('#RessourcesMobilisees').append($(`<img height="75px" width="75px" class="mb-3 ml-3" onclick="$('#ModaleAddUser').modal('show'); " src="Assets/Image/Ressources/addUser.png">`))
      }
    })
  }

    $('#AddRessourceToProject').bind( "click", function() { 

      if ($('#TOUTLEMONDE').val() != '') {
        $.ajax({
          url: "Modele/ProjectInformation.php",
          method: "POST",
          data: {
            projectId: projectId,
            UserId: $('#TOUTLEMONDE').val(),
            action: "AddRessource"
          },
          success: function (data) {
            Notify(data,'Resource(s) ajoutée(s)')
            GetRessources()
          }
        });
      } else
        $.notify("Aucune ressource selectionnée ?", "error");

     });

    function SuppRessource(infos) {

      var idRessource = infos[0].id.split('_')[1]
      var RessourceNom = infos[0].nextSibling.textContent

      if (confirm("Es-tu sûr de vouloir supprimer "+RessourceNom+" ?"))

          $.ajax({
            url: "Modele/ProjectInformation.php",
            method: "POST",
            data: {
              idRessource: idRessource,
              action: "DellRessourceProjet"
            },
            success: function (data) {
              Notify(data,'Ressource '+RessourceNom+' supprimée')
              GetRessources();
            }
          });
      
    }

    //+-+-+-+-+-+-+-+-+-+-+ Infos Note +-+-+-+-+-+-+-+-+-+-+

    function GetNote(){
    $.ajax({
      url: "Modele/ProjectInformation.php",
      method: "POST",
      data: {
        projectId: projectId,
        action: "getNote"
      },
      dataType: "json",
      success: function (data) {
        $('#Note').text(data.Note);
      }
    });
    }

    $('#putNote').bind( "click", function() {

      $.ajax({
          url: "Modele/ProjectInformation.php",
          method: "POST",
          data: {
            Note_Text: $('#Note').val(),
            projectId: projectId,
            action: "putNote"
          },
          success: function (data) {
            Notify(data,'Note éditée')
          }
        });
    })

    //+-+-+-+-+-+-+-+-+-+-+ Technos +-+-+-+-+-+-+-+-+-+-+

    function GetTechnos() {
      $('#TechnologiesProjet').html('')

      $.ajax({
        url: "Modele/ProjectInformation.php",
        method: "POST",
        data: {
          projectId: projectId,
          action: "GetTechnos"
        },
        dataType: "json",
        success: function (data) {

          $.each(data, function () {

            var divTechnologie = $(`<div class="ml-3"></div>`);

            divTechnologie.append($(`<img class="" height="75px" width="75px" src="` + `Assets/Image/Autre/Logo_Code.png">`))
            divTechnologie.append($(`<img id="`+this.technologieId+`" height="25px" width="25px" style="position: relative;left: -19px;top: -27px;" src="` + `Assets/Image/Autre/delete.png">`).bind( "click", function() {
              SuppTechno($(this))
          }));

            divTechnologie.append($(`<p class="mb-3 centered pr-4">`+this.technologie+`</p>`))

            $('#TechnologiesProjet').append(divTechnologie)
          })
        
          $('#TechnologiesProjet').append($(`<img id="AddTechnoModal" height="75px" width="75px" class="mb-3 ml-3" src="Assets/Image/Autre/AddLanguage.png">`).bind( "click", function() {
            ShowAndClearModaleForNew('ModaleTechno')
          }))

        }
      });
    }
    
    $('#AddTechnoToProject').bind( "click", function() {
      
      var NouvelleTechno = $('#inputTechno').val()

      if (NouvelleTechno != undefined && NouvelleTechno != '' && NouvelleTechno != null) {
        $.ajax({
          url: "Modele/ProjectInformation.php",
          method: "POST",
          data: {
            projectId: projectId,
            NouvelleTechno: NouvelleTechno,
            action: "AddTechno"
          },
          success: function (data) {
            Notify(data,'Technologie '+NouvelleTechno+' ajoutée')
            GetTechnos();
            $('#inputTechno').val('')
          }
        });
      }
      else {
        $.notify("Il faut du texte pour la techno.", "error");
      }
    })

    function SuppTechno(infos) {

      var idTechno = infos[0].id.split('_')[1]
      var nomTechno = infos[0].nextSibling.textContent

      if (confirm("Es-tu sûr de vouloir supprimer '"+nomTechno+"' ?"))
        $.ajax({
          url: "Modele/ProjectInformation.php",
          method: "POST",
          data: {
            idTechno: idTechno,
            NomTechno: nomTechno,
            action: "DellTechno"
          },
          success: function (data) {
            Notify(data,'Technologie '+nomTechno+' supprimée')
            GetTechnos();
          }
        });
    }

    //+-+-+-+-+-+-+-+-+-+-+ Echange +-+-+-+-+-+-+-+-+-+-+
    
    $('#ModaleAddEchange').bind( "click", function() {
      ShowAndClearModaleForNew('ModaleComment','EditEchange','AddEchange')
      $('#Echange_Date').val(CustomYourDate(ChoixDate(0),'dd/mm/yyyy'));
      $('#Echange_Label').val('');
    });

    function GetEchange(idComment){

      $('#AddEchange').hide()
      $('#EditEchange').show()

      $.ajax({
        url: "Modele/ProjectInformation.php",
        method: "POST",
        data: {
          idComment: idComment,
          action: "getEchange"
        },
        dataType: "json",
        success: function (data) {
          $('#ModaleComment').modal('show');

          $('#Echange_Label').val(data.resume_echange);
          $('#Echange_Date').val(data.date_echange);
          $('#Echange_Type').val(data.type_echange);

          $('#Echange_ID').val(data.id_echange);
        }
      });

      }

    function GetEchanges(){
    
    $('#EchangesProjet').html('')
    
    $.ajax({
      url: "Modele/ProjectInformation.php",
      method: "POST",
      data: {
        projectId: projectId,
        action: "getEchanges"
      },
      dataType: "json",
      success: function (data) {

      $.each(data, function () {

        var divEchange = $(`<tr>
                <td>`+this.resume_echange+`</td>
                <td>`+this.date_echange+`</td>
                <td>`+this.type_echange+`</td>
              </tr>`);

        var $colloneBoutons = $('<td />');

        var $GroupBouton = $('<div class="btn-group" role="group" />');

        $GroupBouton.append($('<button type="button" id="EditResume_'+this.id_echange+'" class="btn btn-warning mr-1 btn-sm"><i class="fa fa-pencil" aria-hidden="true"></i></button>').on('click', function() {
          GetEchange(this.id.split('_')[1])
        }));

        $GroupBouton.append($('<button type="button" id="DeleteResume_'+this.id_echange+'" class="btn btn-danger btn-sm"><i class="fa fa-times" aria-hidden="true"></i></button>').on('click', function() {
          DellEchange(this.id.split('_')[1])
        }));
        
        $colloneBoutons.append($GroupBouton);
        divEchange.append($colloneBoutons);

        $('#EchangesProjet').prepend(divEchange)

      })
      IfNoRows('EchangesProjet','Aucun échange trouvé..')
      }
    });
    
    }

    $('#AddEchange').bind( "click", function() { 

      $.ajax({
          url: "Modele/ProjectInformation.php",
          method: "POST",
          data: {
            projectId: projectId,
            echange_label: document.getElementById('Echange_Label').value,
            echange_date: CustomYourDate($('#Echange_Date').val()),
            echange_type: $("#Echange_Type").val(),
            action: "postEchange"
          },
          success: function (data) {
            Notify(data,'Echange '+document.getElementById('Echange_Label').value+' ajouté')
            GetEchanges();
          }
        });

    });

    $('#EditEchange').bind( "click", function() {

      $.ajax({
          url: "Modele/ProjectInformation.php",
          method: "POST",
          data: {
            echange_id: document.getElementById('Echange_ID').value,
            echange_label: document.getElementById('Echange_Label').value,
            echange_date: CustomYourDate($('#Echange_Date').val()),
            echange_type: $("#Echange_Type").val(),
            action: "putEchange"
          },
          success: function (data) {
            Notify(data,'Echange '+document.getElementById('Echange_Label').value+' modifié')
            GetEchanges();
          }
        });

      $('#ModaleComment').modal('hide');

     });

    function DellEchange(idEchange) {

      if (confirm("Es-tu sûr de vouloir supprimer cet échange ?"))
        $.ajax({
          url: "Modele/ProjectInformation.php",
          method: "POST",
          data: {
            projectId: projectId,
            idEchange: idEchange,
            action: "DellEchange"
          },
          success: function (data) {
            Notify(data,'Echange bien supprimé')
            GetEchanges();
          }
        });
    };
  
    //+-+-+-+-+-+-+-+-+-+-+ Timeline +-+-+-+-+-+-+-+-+-+-+

    function GetTimeLine(){

      google.charts.load("current", {packages:["timeline"]});
      google.charts.setOnLoadCallback(drawChart);
      function drawChart() {
        var container = document.getElementById('ProjectTimeLine');
        var chart = new google.visualization.Timeline(container);
        var dataTable = new google.visualization.DataTable();
        dataTable.addColumn({ type: 'string', id: 'vide' });
        dataTable.addColumn({ type: 'string', id: 'Name' });
        dataTable.addColumn({ type: 'date', id: 'Start' });
        dataTable.addColumn({ type: 'date', id: 'End' });
        dataTable.addRows([
          [ 'Projet', 'Design maquette', new Date(1789, 3, 30), new Date(1797, 2, 4) ],
          [ 'Projet', 'Développement', new Date(1797, 2, 4), new Date(1801, 2, 4) ],
          [ 'Projet', 'Intégration', new Date(1801, 2, 4), new Date(1809, 2, 4) ]]);

        var options = {
        };

        chart.draw(dataTable, options);
      }
    }
  
  })
</script>