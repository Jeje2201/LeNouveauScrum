<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<body class="fixed-nav sticky-footer" id="page-Result">
  <div class="content-wrapper">
    <div class="container-fluid">

      <div class="row mb-3">
        
        <div class="col">
            <span>Sprint</span>
          <div id="ListSrint"></div>
        </div>

        <div class="col">
          <span>&nbsp;</span>
            <button type="button" id="Descendre" class="btn btn-info btn-block">Valider</button>
        </div>

      </div>

      <div class="row">
        <div class="col" id="EnCours"></div>
    </div>
    </div>
  </body>
  <script>
    $(document).ready(function () {

      RequeteAjax('ListSrint', 'ListeDeroulanteSprint', 'Modele/RequetesAjax.php');

      AfficherCards();

      function AfficherCards() {
        $.ajax({
          url: "Modele/Tache.php",
          method: "POST",
          dataType: "json",
          data: {
            action: "AfficherCards",
            idAffiche: $('#numeroSprint').val()
          },
          success: function (data) {
            $('#EnCours').html(data);
          }
        });
      }

      $('#numeroSprint').change(function () {
        AfficherCards();
      });


      $('#Descendre').click(function () {
        
        $.ajax({
              url: "Modele/Tache.php",
              method: "POST",
              async: "false",

              dataType: "json",
              data: {
                action: "DateMinMax",
                idAffiche: $('#numeroSprint').val()
              },
              success: function (data) {

                if (CustomYourDate(ChoixDate(0)) >= data.sprint_dateDebut && CustomYourDate(ChoixDate(0)) <= data.sprint_dateFin) {
                  var dateDescente = CustomYourDate(ChoixDate(0));
                } else {
                  var dateDescente = data.sprint_dateFin;
                }

                var IdAttribue = [];

                $('.TacheGonnaBeDone').each(function () {
                  IdAttribue.push($(this).attr('id'));
                });

                $('.TacheGonnaBeDone').each(function () {

                  var TextDeLaTache = $(this)
                    .children('#LabelDeLaTache')
                    .text()
                  var Project_id_Pivotal = $(this)
                    .children('#ProjectIdPivotal')
                    .text()
                  var Story_id_Pivotal = $(this)
                    .children('#StoryId')
                    .text()
                  var Task_id_Pivotal = $(this)
                    .children('#TaskId')
                    .text()

                    console.log('tache pivotal validé par l api\nProjet Api: '+ Project_id_Pivotal+'\nStory id pivtoal: '+ Story_id_Pivotal+'\n Tache id pivotal:'+ Task_id_Pivotal)

                  if (Project_id_Pivotal != "" && Story_id_Pivotal != "" && Task_id_Pivotal != "") {

                    $.ajax({
                      url: "https://www.pivotaltracker.com/services/v5/projects/" + Project_id_Pivotal + "/stories/" + Story_id_Pivotal + "/tasks/" + Task_id_Pivotal,
                      beforeSend: function (xhr) {
                        xhr.setRequestHeader('X-TrackerToken', 'b4a752782f711a7c564221c2b0c2d5dc');
                      },
                      type: 'PUT',
                      processData: false,
                      data: 'complete=true',
                      error: function (XMLHttpRequest, textStatus, errorThrown) {
                        $.notify(errorThrown, "error");
                      },
                      success: function (data) {
                        //Liste des stories trouvées
                        $.notify("Story validée aussi dans Pivotal Tracker !", "success");
                      }
                    })

                    $.ajax({
                      url: "https://www.pivotaltracker.com/services/v5/projects/" + $(this)
                        .children('#ProjectIdPivotal')
                        .text() + "/stories/" + $(this)
                        .children('#StoryId')
                        .text() + "/comments",
                      beforeSend: function (xhr) {
                        xhr.setRequestHeader('X-TrackerToken', 'b4a752782f711a7c564221c2b0c2d5dc');
                      },
                      type: 'POST',
                      processData: false,
                      data: 'text= Tâche validée sur Scrum Manager par ' + document.getElementById('TitreNavBar').text.split('Ns Scrum - ')[1] + ' : ' + TextDeLaTache,
                      error: function (XMLHttpRequest, textStatus, errorThrown) {
                        $.notify(errorThrown, "error");
                      },
                      success: function (data) {
                        $.notify("Ajout d'un commentaire dans Pivotal Tracker", "success");
                      }
                    })
                  }
                  });


                  if (IdAttribue != '') {
          $.ajax({
            url: "Modele/Tache.php",
            method: "POST",
            data: {
              IdAttribue: IdAttribue,
              action: "Descendre",
              LeJourDeDescente: dateDescente
            },
            success: function (data) {
              $.notify(data, "success");
              AfficherCards();
            }
          });
        } else {
          $.notify(`Tu dois d'abord déplacer au moins une tâche de son emplacement "En cours" -> "Achevée."`, "error");
        }
            
        }
      });

    });

    });

    function DeplaceToi(id) {
      $(id).toggleClass("TacheGonnaBeDone");  
    }
  </script>
