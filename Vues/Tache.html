<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<body class="fixed-nav sticky-footer" id="page-Result">
  <div class="content-wrapper">
    <div class="container-fluid">

      <div class="hideElement" name="DateAujourdhui" id='DateAujourdhui'></div>

      <div class="row">
        
        <div class="col-lg-6">
            <span>Sprint</span>
          <div id="ListSrint"></div>
        </div>

        <div class="col-lg-6">
          <span>&nbsp;</span>
            <button type="button" id="Descendre" class="btn btn-info btn-block">Valider</button>
        </div>

      </div>

      <p></p>

      <div class="row">
        <div class="col-lg-6">
          <div class="card">
            <div class="card-header centered">
              En cours
            </div>
            <div class="card-body card-columns DeplacementDeTache" id="EnCours"></div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card">
            <div class="card-header centered">
              Validée
            </div>
            <div class="card-body card-columns DeplacementDeTache" id="Fini"></div>
          </div>

        </div>
      </div>
    </div>
  </body>
  <script>
    $(document).ready(function () {

      // $("div.DeplacementDeTache").sortable({connectWith: "div", cancel: ".PASTOUCHE"});

      // $("#EnCours, #Fini").disableSelection();

      // $('#DateAujourdhui').datetimepicker({format: 'dd-mm-yyyy', autoclose: true, minView: 2, weekStart: 1});

      RequeteAjax('ListSrint', 'ListeDeroulanteSprint', 'Modele/RequetesAjax.php');

      AfficherCards();

      function AfficherCards() {
        $.ajax({
          url: "Modele/Tache.php",
          method: "POST",
          data: {
            action: "AfficherCards",
            idAffiche: $('#numeroSprint').val()
          },
          success: function (data) {
            $('#EnCours').html(data.Attribution);
            $('#Fini').html(data.Descendue);

            $.ajax({
              url: "Modele/Tache.php",
              method: "POST",
              data: {
                action: "DateMinMax",
                idAffiche: $('#numeroSprint').val()
              },
              success: function (data) {
                // $('#DateAujourdhui').datetimepicker('setStartDate', data['DateMin']);
                // $('#DateAujourdhui').datetimepicker('setEndDate', data['DateMax']);

                if (DateFrToEn(ChoixDate(0)) >= DateFrToEn(String(data['DateMin'])) && DateFrToEn(ChoixDate(0)) <= DateFrToEn(String(data['DateMax']))) {
                  $('#DateAujourdhui').text(ChoixDate(0));
                } else {
                  $('#DateAujourdhui').text(data['DateMax']);
                }
              }
            });
          }
        });
      }

      $('#numeroSprint').change(function () {
        AfficherCards();
      });


      $('#Descendre').click(function () {

        var IdAttribue = [];

        $('#Fini .BOUGEMOI').each(function () {
          IdAttribue.push($(this).attr('id'));
        });

        $('#Fini .BOUGEMOI div').each(function () {

          var TextDeLaTache = $(this)
            .children('#LabelDeLaTache')
            .text()
          var Project_id_Pivotal = $(this)
            .children('#ProjectIdPivotal')
            .text()
          var Story_id_Pivotal = $(this)
            .children('#StoryId')
            .text()
          var Task_id_Pivotal = $(this)
            .children('#TaskId')
            .text()

          if (Project_id_Pivotal != "" && Story_id_Pivotal != "" && Task_id_Pivotal != "") {

            $.ajax({
              url: "https://www.pivotaltracker.com/services/v5/projects/" + Project_id_Pivotal + "/stories/" + Story_id_Pivotal + "/tasks/" + Task_id_Pivotal,
              beforeSend: function (xhr) {
                xhr.setRequestHeader('X-TrackerToken', 'b4a752782f711a7c564221c2b0c2d5dc');
              },
              type: 'PUT',
              processData: false,
              data: 'complete=true',
              error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.notify(errorThrown, "error");
              },
              success: function (data) {
                //Liste des stories trouvées
                $.notify("Story validée aussi dans Pivotal Tracker !", "success");
              }
            })

            $.ajax({
              url: "https://www.pivotaltracker.com/services/v5/projects/" + $(this)
                .children('#ProjectIdPivotal')
                .text() + "/stories/" + $(this)
                .children('#StoryId')
                .text() + "/comments",
              beforeSend: function (xhr) {
                xhr.setRequestHeader('X-TrackerToken', 'b4a752782f711a7c564221c2b0c2d5dc');
              },
              type: 'POST',
              processData: false,
              data: 'text= Tâche validée sur Scrum Manager par ' + $("#numeroEmploye option:selected").text() + ' : ' + TextDeLaTache,
              error: function (XMLHttpRequest, textStatus, errorThrown) {
                $.notify(errorThrown, "error");
              },
              success: function (data) {
                $.notify("Ajout d'un commentaire dans Pivotal Tracker", "success");
              }
            })
          }
        });

        if (IdAttribue != '') {
          $.ajax({
            url: "Modele/Tache.php",
            method: "POST",
            data: {
              IdAttribue: IdAttribue,
              action: "Descendre",
              LeJourDeDescente: DateFrToEn($('#DateAujourdhui').text())
            },
            success: function (data) {
              $.notify(data, "success");
              AfficherCards();
            }
          });
        } else {
          $.notify(`Tu dois d'abord déplacer au moins une tâche de son emplacement "En cours" -> "Achevée."`, "error");
        }

      });

    });

    function DeplaceToi(id) {

      if ($(id).parent().attr('id') == 'EnCours') {
        $(id).prependTo($("#Fini"));

      } else {
        $(id).prependTo($("#EnCours"));
      }
    }
  </script>
