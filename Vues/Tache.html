<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<body class="fixed-nav sticky-footer" id="page-Result">
  <div class="content-wrapper">
    <div class="container-fluid">

      <div class="row py-2" style="padding-right: 192px;top: 0;position: fixed;z-index: 200;background: #ffffffed;width: inherit;">
        
        <div class="col">
            <span>Sprint</span>
          <div id="ListSrint"></div>
        </div>

        <div class="col">
          <span>&nbsp;</span>
            <button  id="Descendre" class="btn btn-success btn-block">Valider</button>
        </div>

      </div>

      <div class="row">
        <div class="col" id="EnCours" style="margin-top: 70px;"></div>
    </div>
    </div>
  
  <script>
    $(document).ready(function () {

      RequeteAjax('ListSrint', 'ListeDeroulanteSprint', 'Modele/RequetesAjax.php');

      AfficherCards();

      var ApiPivotalKey = ""

      $.ajax({
        url: "Modele/Autre.php",
        method: "POST",
        async: 'false',
        data: {
          action: "getApiPivotalKey"
        },
        success: function (data) {
          ApiPivotalKey = data.trim()
        }
      })

      function AfficherCards() {
        $.ajax({
          url: "Modele/Tache.php",
          method: "POST",
          data: {
            action: "AfficherCards",
            idAffiche: $('#numeroSprint').val()
          },
          success: function (data) {
            $('#EnCours').html(data);
          }
        });
      }

      $('#numeroSprint').change(function () {
        AfficherCards();
      });

      $('#Descendre').click(function () {
        
        $.ajax({
              url: "Modele/Tache.php",
              method: "POST",
              async: "false",

              dataType: "json",
              data: {
                action: "DateMinMax",
                idAffiche: $('#numeroSprint').val()
              },
              success: function (data) {

                if($('.TacheGonnaBeDone').length == 0){
                  $.notify(`Tu dois d'abord déplacer au moins une tâche de son emplacement "En cours" -> "Achevée."`, "error");
                  return
                }

                if (CustomYourDate(ChoixDate(0)) >= data.sprint_dateDebut && CustomYourDate(ChoixDate(0)) <= data.sprint_dateFin) {
                  var dateDescente = CustomYourDate(ChoixDate(0));
                } else {
                  var dateDescente = data.sprint_dateFin;
                }

                $('.TacheGonnaBeDone').each(function () {

                  var TextDeLaTache = $(this).children('#LabelDeLaTache').text()
                  var Project_id_Pivotal = $(this).children('#ProjectIdPivotal').text()
                  var Story_id_Pivotal = $(this).children('#StoryId').text()
                  var Task_id_Pivotal = $(this).children('#TaskId').text()
                  var Tache_bdd_id = $(this).attr('id')

                  if (Project_id_Pivotal != "" && Story_id_Pivotal != "" && Task_id_Pivotal != "") {

                    $.ajax({
                      url: "https://www.pivotaltracker.com/services/v5/projects/" + Project_id_Pivotal + "/stories/" + Story_id_Pivotal + "/tasks/" + Task_id_Pivotal,
                      beforeSend: function (xhr) {
                        xhr.setRequestHeader('X-TrackerToken', ApiPivotalKey);
                      },
                      type: 'PUT',
                      processData: false,
                      data: 'complete=true',
                      statusCode: {
                        503: function(responseObject, textStatus, errorThrown) {
                          $.notify("Trop de tâches d'un coup. \""+TextDeLaTache+"\" ne s'est pas faite validée par l'API de Pivotal Tracker", "error");                      
                        },
                        200: function(responseObject, textStatus, errorThrown) {
                          $.notify("Tâche \""+TextDeLaTache+"\" validé !", "success");  

                          $.ajax({
                            url: "Modele/Tache.php",
                            method: "POST",
                            data: {
                              IdAttribue: Tache_bdd_id,
                              action: "Descendre",
                              LeJourDeDescente: dateDescente
                            },
                            success: function (data) {
                              AfficherCards();
                            }
                          });
                        }
                      }
                    })
                  }else{
                    $.ajax({
                      url: "Modele/Tache.php",
                      method: "POST",
                      data: {
                        IdAttribue: Tache_bdd_id,
                        action: "Descendre",
                        LeJourDeDescente: dateDescente
                      },
                      success: function (data) {
                        AfficherCards();
                        $.notify("Tâche \""+TextDeLaTache+"\" validé !", "success");  
                      }
                    });
                  }
                  });

        }
        
      });

    });

    });

    function DeplaceToi(id) {
      $(id).toggleClass("TacheGonnaBeDone");  
    }
  </script>
