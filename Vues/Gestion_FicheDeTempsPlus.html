<body class="fixed-nav sticky-footer" id="page-top">
  <div class="content-wrapper">
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-12">

          <h3>Temps passé sur un projet selon les fiches de temps</h3>
          <div class="row">
            <div class="col">
              <label>Projet</label>

              <div id="ListProjet"></div>
            </div>
            <div class="col">
              <label>Début</label>

              <input type="text" data-type="datetimepicker" class="form-control" id="Start">
            </div>

            <div class="col">
              <label>Fin</label>
              <input type="text" data-type="datetimepicker" class="form-control" id="Finish">
            </div>
          </div>
          <div class="row">
            <div class="col-lg-12">
              <input class="form-control" id="BarreDeRecherche" type="text" placeholder="Rechercher..">
            </div>
          </div>
          <div id="TableauListFicheDeTemps" class="table-responsive table-hover"></div>

        </div>

      </div>

        <h3 class="mt-4">Temps passé par une ressource selon les fiches de temps</h3>

        <div class="row">
          <div class="col-lg-4">
            <label>User</label>
            <select class="form-control" id="ListeRessource">
            </select>
            </div>
          <div class="col-lg-4">
            <label>Début</label>

            <input type="text" data-type="datetimepicker" class="form-control" id="StartSelonRessource">
          </div>

          <div class="col-lg-4">
            <label>Fin</label>
            <input type="text" data-type="datetimepicker" class="form-control" id="FinishSelonRessource">
          </div>
        </div>

        <div class="row mt-4">
          <div class="col-lg-12">
            <table class="table table-sm table-striped table-bordered">
              <thead>
                <tr>
                  <th>Projet</th>
                  <th>Jour(s) travaillé(s) (un jour = 7h24)</th>
                  <th>Jour(s) travaillé(s) (sans arrondie au 0.5)</th>
                </tr>
              </thead>
              <tbody id="FicheDeTempsSelonRessource">
                
              </tbody>
            </table>
          </div> 
      </div>

    </div>

    <script>
      $(document).ready(function () {

        RequeteAjax('ListProjet', 'ListeDeroulanteProjetAvecCir', 'Modele/RequetesAjax.php');
        FillEmptySelect('ListeRessource','GetUsers','Modele/User.php','LaListeDesUsers')
        BarreDeRecherche('BarreDeRecherche', 'TableauListFicheDeTemps');
        $("#projetId").select2({width: "100%"});

        $('#Start').val(CustomYourDate(ChoixDate(-7),'dd/mm/yyyy'));
        $('#Finish, #StartSelonRessource, #FinishSelonRessource').val(CustomYourDate(ChoixDate(0),'dd/mm/yyyy'));

        ChargerTableauListeFdT()
        ChargerTableauSelonRessource()

        function ChargerTableauListeFdT() {
          $.ajax({
            url: "Modele/FicheDeTemps.php",
            method: "POST",
            data: {
              action: "ListeSelonProjetDateRessource",
              ProjetId: $('#projetId').val(),
              Start: CustomYourDate($('#Start').val()),
              Finish: CustomYourDate($('#Finish').val())
            },
            success: function (data) {
              $('#TableauListFicheDeTemps').html(data);
              GarderLaRecherche('BarreDeRecherche', 'TableauListFicheDeTemps');
            }
          });
        }

        function ChargerTableauSelonRessource(){
          $.ajax({
            url: "Modele/FicheDeTemps.php",
            method: "POST",
            dataType: "json",
            data: {
              action: "ListTotalSurDateSelonUser",
              User: $('#ListeRessource').val(),
              Start: CustomYourDate($('#StartSelonRessource').val()),
              End: CustomYourDate($('#FinishSelonRessource').val())
            },
            success: function (data) {

              $('#FicheDeTempsSelonRessource').html('')

              $.each(data, function () {
                $('#FicheDeTempsSelonRessource').prepend(`<tr>
                    <td>`+this.projet_nom+`</td>
                    <td>`+FredCestPasCool(this.Temps)+`</td>
                    <td>`+Math.trunc(this.Temps * 100)/100  +`</td>
                  </tr>`);
              })

              IfNoRows('FicheDeTempsSelonRessource','Aucune fiche de temps trouvée..')

            }
    });
        }

          $('#ListProjet, #Start, #Finish').change(function () {
            if ($('#projetId').val() != '' && $('#Start').val() != '' && $('#Finish').val()) {
              ChargerTableauListeFdT()
            }
          });

          $('#ListeRessource, #StartSelonRessource, #FinishSelonRessource').change(function () {
            ChargerTableauSelonRessource()
          });

          function FredCestPasCool(nombre){
            //on coupe notre nombre en deux en se basant sur le point, donc 17.21 va devenir 17 d'un coté et 21 de l'autre
            separation = (nombre + "").split(".");

            //Si en coupant sur le point il trouve des nombre derriere, c'est qu'on a une décimal donc on va jouer avec
            if(separation[1]){

              //La décimal peut etre du genre 4568494984 donc on la coupe avec seulement les deux premier soit 45
              separation[1] = separation[1].substring(0,2);

              //ensuite on regarde la décimal pour savoir quoi faire

              //Si notre décimal est sup a 50 alors on ajout 1 a notre nombre sans les décimal donc 17.52 -> 18
              if(separation[1] > 50){
                nombre = parseInt(separation[0])+1
              }
              
              //Sinon si notre nombre est < 50 mais > 00 alors on prend le nombre entier, et on lui dit que sa décimal vaut 50
              else if(separation[1] < 50 && separation[1] > 0){
                nombre = Math.trunc(nombre)+0.5
              }
            }

            //Sinon si notre nombre tombe exactement sur 0.5 ou 00 on ne fait rien car on ne rentre dans aucune des deux cas vu audessus
            return nombre
          }

        })
    </script>
