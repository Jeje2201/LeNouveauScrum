<body class="fixed-nav sticky-footer" id="page-top">
  <div class="content-wrapper">
    <div class="container-fluid">

      <div class="card">
        <div class="card-header">
          <b>Créer sprint</b>
        </div>
        <div class="card-body">
          <!-- Selectionner le sprint sur lequel l'on va jouer -->

          <div class="input-group">

            <div class="input-group-prepend">
              <span class="input-group-text">Sprint n°</span>
            </div>
            <input type="number" name="numero" id='numero' class="form-control">

            <div class="input-group-prepend">
              <span class="input-group-text">
                <span class="fa fa-calendar"></span>&nbsp;Début</span>
            </div>
            <input type="text" name="dateDebut" id='dateDebut' class="form-control" />

            <div class="input-group-prepend">
              <span class="input-group-text">
                <span class="fa fa-calendar"></span>&nbsp;Fin</span>
            </div>
            <input type="text" name="dateFin" id='dateFin' class="form-control" />

            <div class="input-group-prepend">
              <span class="input-group-text">Attribuable (h)</span>
            </div>
            <input type="number" name="attribuable" id='attribuable' value='60' min='1' max='77' class="form-control">

            <div class="btn-group " role="group" aria-label="Basic example">
              <button type="button" id="modal_button" class="btn btn-info">
                <i class="fa fa-plus" aria-hidden="true"></i>&nbsp;Créer Sprint</button>
              <button type="button" id="BouttonInfo" class="btn btn-secondary">?</button>
            </div>
          </div>
        </div>

      </div>

      <div class="mb-3">
        <input class="form-control" id="BarreDeRecherche" type="text" placeholder="Rechercher..">
      </div>

      <div id="result" class="table-responsive table-hover"> </div>

      <!-- This is sprint Modal. It will be use for Create new Records and Update Existing Records!-->
      <div id="ModalInfoAttribuable" class="modal fade">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">Raison pour laquelle 60 est le nombre d'heures attribuables par défaut</h4>
            </div>
            <div class="modal-body">

              <img src="Assets/Image/InfoHeureAttribuable.png" width="100%">
              <p>Par jour est attribuable un certain nombre d'heures.
                <br>Certains jours en auront moins. Le premier lundi de chaque sprint par exemple a seulement 4h
                attribuable
                car 3h sont déjà attribuées pour la planification des tâches.
                <br>Le résultat par défaut est donc de 60h pour 9j soit 1 sprint complet.</p>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
            </div>
          </div>
        </div>
      </div>

      <div id="ModalSprint" class="modal fade">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title"></h4>
            </div>
            <div class="modal-body">
              <label>Numero</label>
              <input type="number" name="numero" id='numeroo' class="form-control">
              <br />
              <label>Date Debut</label>
              <input type="text" name="dateDebut" id='dateDebutt' class="form-control" />
              <br />
              <label>Date Fin</label>
              <input type="text" name="dateFin" id='dateFinn' class="form-control" />
              <br />
              <label>Attribuable (h)</label>
              <input type="number" name="attribuableEdition" id='attribuableEdition' min="1" class="form-control" />
              <br />
            </div>
            <div class="modal-footer">
              <input type="hidden" name="id" id="id" />
              <input type="submit" name="action" id="action" class="btn btn-success" />
              <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>
</body>
<script>

  $(document).ready(function () {

    $('#dateDebut').val(ChoixDate(0));

    $('#dateFin').val(ChoixDate(14));

    GetNumeroSprintMax('numero');

    BarreDeRecherche('BarreDeRecherche', 'result');

    RequeteAjax('result', 'Load', 'Modele/ActionSprint.php')

    $('#dateDebut,#dateFin,#dateDebutt,#dateFinn').datetimepicker({
      format: 'dd-mm-yyyy',
      autoclose: true,
      minView: 2
    });

    $('#BouttonInfo').click(function () {
      $('#ModalInfoAttribuable').modal('show');
    });

    function GetNumeroSprintMax(Div) {
      $.ajax({
        url: "Modele/ActionSprint.php",
        method: "POST",
        data: {
          action: "SprintMax"
        },
        success: function (data) {
          $('#' + Div).val(data.replace(/\s+/g, ''));
        }
      });
    }

    $('#modal_button').click(function () {

      if (DateFrToEn($('#dateFin').val()) > DateFrToEn($('#dateDebut').val())) {
        if ($('#numero').val() != '' && DateFrToEn($('#dateDebut').val()) != '' && DateFrToEn($('#dateFin').val()) != '') {
          $.ajax({
            url: "Modele/ActionSprint.php",
            method: "POST",
            data: {
              numero: $('#numero').val(),
              dateDebut: DateFrToEn($('#dateDebut').val()),
              id: $('#id').val(),
              dateFin: DateFrToEn($('#dateFin').val()),
              Attribuable: $('#attribuable').val(),
              action: 'Créer'
            },
            success: function (data) {

              BootstrapAlertDefaut(data);
              GetNumeroSprintMax('numero');
              RequeteAjax('result', 'Load', 'Modele/ActionSprint.php')

            }
          });
        }
        else {
          BootstrapAlertError("Tous les champs doivent être plein.");
        }
      }
      else {
        BootstrapAlertError("La date de début est supérieure à celle de fin, comment tu veux que ça marche ?");
      }
    });

    //This JQuery code is for Update sprint data. If we have click on any sprint row update button then this code will execute
    $(document).on('click', '.update', function () {
      var id = $(this).attr("id"); //This code will fetch any sprint id from attribute id with help of attr() JQuery method 
      $.ajax({
        url: "Modele/ActionSprint.php",   //Request send to "ActionSprint.php page"
        method: "POST",    //Using of Post method for send data
        data: {
          id: id,
          action: "Select" //We have define action variable value is equal to select
        },//Send data to server
        dataType: "json",   //Here we have define json data type, so server will send data in json format.
        success: function (data) {
          $('#ModalSprint').modal('show');   //It will display modal on webpage
          $('.modal-title').text("Changer infos sprint"); //This code will change this class text to Update records
          $('#action').val("Update");     //This code will change Button value to Update
          $('#id').val(id);     //It will define value of id variable to this sprint id hidden field
          $('#numeroo').val(data.numero);  //It will assign value to modal first name texbox
          $('#dateDebutt').val(data.dateDebut);  //It will assign value of modal last name textbox
          $('#dateFinn').val(data.dateFin);  //It will assign value of modal last name textbox
          $('#attribuableEdition').val(data.attribuable);
        }
      });
    });

    $('#action').click(function () {
      if($('#numeroo').val() != '' && DateFrToEn($('#dateDebutt').val()) != '' && DateFrToEn($('#dateFinn').val()) != '' && $('#attribuableEdition').val() > 0) //This condition will check both variable has some value
      {
        $.ajax({
          url: "Modele/ActionSprint.php",    //Request send to "ActionSprint.php page"
          method: "POST",     //Using of Post method for send data
          data: {
            numero: $('#numeroo').val(),
            dateDebut: DateFrToEn($('#dateDebutt').val()),
            id: $('#id').val(),
            dateFin: DateFrToEn($('#dateFinn').val()),
            attribuableEdi: $('#attribuableEdition').val(),
            action: $('#action').val()//Get the value of Modal Action button and stored into action variable
          }, //Send data to server
          success: function (data) {
            BootstrapAlertDefaut(data);
            $('#ModalSprint').modal('hide'); //It will hide sprint Modal from webpage.
            RequeteAjax('result', 'Load', 'Modele/ActionSprint.php')    // Fetch User function has been called and it will load data under divison tag with id result
          }
        });
      }
      else {
        BootstrapAlertError("Tous les champs doivent être plein."); //If both or any one of the variable has no value them it will display this message
      }
    });

    //This JQuery code is for Delete sprint data. If we have click on any sprint row delete button then this code will execute
    $(document).on('click', '.delete', function () {
      if (confirm("Es-tu sûr de vouloir supprimer ce sprint?")) //Confim Box if OK then
      {
        $.ajax({
          url: "Modele/ActionSprint.php",    //Request send to "ActionSprint.php page"
          method: "POST",     //Using of Post method for send data
          data: {
            id: $(this).attr("id"), //This code will fetch any sprint id from attribute id with help of attr() JQuery method 
            action: "Delete" //Define action variable value Delete
          }, //Data send to server from ajax method
          success: function (data) {
            RequeteAjax('result', 'Load', 'Modele/ActionSprint.php')    // fetchUser() function has been called and it will load data under divison tag with id result
            BootstrapAlertDefaut(data);
          }
        })
      }
      else  //Confim Box if cancel then 
      {
        return false; //No action will perform
      }
    });

    $('#dateFin, #dateDebut').datetimepicker().on('changeDate', function (ev) {

      $("#attribuable").attr({
        "max": (NbJourDeTravail($('#dateDebut').val(), $('#dateFin').val()) * 7)
      });

    });

    $('#dateFin, #dateDebut').datetimepicker().on('click', function (ev) {

      $('#dateFin').datetimepicker('setStartDate', $('#dateDebut').val());

    });

  });
</script>