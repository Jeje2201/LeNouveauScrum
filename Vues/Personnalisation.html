<body class="fixed-nav sticky-footer" id="page-top">
  <div class="content-wrapper">
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-4">
          <div class="card">
            <h5 class="card-header">Couleur cartes</h5>
            <div class="card-body">
              <input type="color" class="" id="CouleurUser">
              <p></p>
              <div class="card BOUGEMOI" style=" border-left: 5px solid;">
                <div style="margin-left:4px;">
                  <b>
                    Prenom Nom | Projet
                    <img class="LogoProjet" src="Assets/Image/Projets/Inconnue.png"></b><br>
                  Texte de la tache
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <h5 class="card-header">Mot de passe</h5>
            <div class="card-body">
              <div class="form-group">
                <label>Ancien mot de passe</label>
                <input type="password" class="form-control" id="ancienmdp" minlength="5" required="required">
                <a class="d-block small mt-3" id="target" style="color:DodgerBlue; cursor:pointer">
                    <u>Mot de passe oublié ?</u>
                  </a>
              </div>
              <div class="form-group">
                <label>Nouveau mot de passe</label>
                <input type="password" class="form-control" id="mdp" minlength="5" required="required">
              </div>
              <div class="form-group">
                <label>Confirmez le mot de passe</label>
                <input type="password" class="form-control" id="confirmmdp" minlength="5" required="required">
              </div>
              <button class="btn btn-primary" id="SetMdp">Sauvegarder</button>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <h5 class="card-header">Total des tâches validées</h5>
            <div class="card-body">
              <div id="TacheValide"></div>
            </div>
          </div>
        </div>
      </div>
      <h2 style="display: inline-flex;">Infos fiches de temps</h2>&Tab;<label>(Les données sont enregistrées depuis Mars 2019)</label>
      <hr>
      <p></p>
      <div id="ListEmpAdmin">
        <div class="form-group">
          <div id="ListEmploye"></div>
        </div>
      </div>
      <div class="row">
        <div class="col-lg-4">
          <div class="card">
            <h5 class="card-header">Fiches de temps / Sprint</h5>
            <div class="card-body">
              <div id="ListSrint"></div>
              <div id="TotRempliSprint"></div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <h5 class="card-header">Fiches de temps / Mois</h5>
            <div class="card-body">
              <div class="form-row">
                <div class="col">
                  <select id="LeMois" class="form-control">
                    <option value="01" selected="selected">Janvier</option>
                    <option value="02">Février</option>
                    <option value="03">Mars</option>
                    <option value="04">Avril</option>
                    <option value="05">Mai</option>
                    <option value="06">Juin</option>
                    <option value="07">Juillet</option>
                    <option value="08">Août</option>
                    <option value="09">Septembre</option>
                    <option value="10">Octobre</option>
                    <option value="11">Novembre</option>
                    <option value="12">Décembre</option>
                  </select>
                </div>
                <div class="col">
                  <select id="LeAnnee" class="form-control">
                    <option value="2019">2019</option>
                    <option value="2020">2020</option>
                  </select>
                </div>
              </div>
              <div id="TotRempliDate"></div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <h5 class="card-header">Fiches de temps / Total</h5>
            <div class="card-body">
              <div id="FicheValide"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="ModalOublieMdp" class="modal fade">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Ta mémoire te fait faillite ?</h4>
          </div>
          <div class="modal-body">
            <p>
              N'ai crainte, oublier son mot de passe sur ScumManager ce n'est pas si grave que ça, et pour cause, un Scrum Master a des pouvoirs magiques si puissants qu'il est capable de réinitialiser ton mot de passe à ses désirs. Seul lui a ce pouvoir car cette magie est si puissante qu'entre de mauvaises mains ce pourrait être la fin du monde..
            </p>
            
            <img src="https://i.imgflip.com/35rso0.jpg" width="100%"></img>
          </div>
        </div>
      </div>
    </div>

  <script>
    $(document).ready(function () {

      //Affiche la modal quand oublie son mot de passe
      $("#target").click(function () {
        $('#ModalOublieMdp').modal('show');
      });

      //Si non scrum master, alors ne pas afficher la liste de ressources
      if ("<?php echo $_SESSION['TypeUtilisateur'] ?>" != "ScrumMaster") 
        $("#ListEmpAdmin").hide();
      
      //Remplace le div "ListEmploye" par une list de ressources
      RequeteAjax('ListEmploye', 'ListeDeroulanteEmployeActif', 'Modele/RequetesAjax.php');
      $('#TypeEmployeOk option[value="' + localStorage.getItem("Connexion") + '"]').attr('selected', 'selected');

      //List de sprints généré pour pouvoir regarder les fiches de temps sur un sprint
      RequeteAjax('ListSrint', 'ListeDeroulanteSprint', 'Modele/RequetesAjax.php');

      //Selectionne par défaut au lancement le mois actuel sur le select de mois
      LeMois = (new Date).getMonth() + 1
      if (LeMois < 10) 
        LeMois = '0' + LeMois
      $('#LeMois option[value="' + LeMois + '"]').attr('selected', 'selected')

      //Charge liste heures fiche de temps sur un sprint au lancement de la page pour les différentes grilles
      ListTotalSurSprint(localStorage.getItem("Connexion"))
      ListTotalFdTSurMois(localStorage.getItem("Connexion"));
      ListTotalTotal(localStorage.getItem("Connexion"));

      //Charge total de temps pour par projets pour les taches validées depuis les premiers logs en bdd
      $.ajax({
        url: "Modele/Parametre.php",
        method: "POST",
        data: {
          action: "LoadTacheValide",
          idRessource: localStorage.getItem('Connexion')
        },
        success: function (data) {
          $('#TacheValide').html(data);
        }
      });

      $.ajax({
        url: "Modele/Parametre.php",
        method: "POST",
        data: {
          action: "GetColor",
          idRessource: localStorage.getItem('Connexion')
        },
        success: function (data) {
          $('#CouleurUser').val('#'+data.split('#')[1].split(' ')[0]);
          $('.BOUGEMOI').css("border-left",  '5px solid #'+data.split('#')[1].split(' ')[0]);
        }
      });

      //Si peut changer le type d'employer, alors charger toutes les infos avec le nouvel utilisateur sélectionné
      $('#TypeEmployeOk').change(function () {
        ListTotalSurSprint($('#TypeEmployeOk').val())
        ListTotalFdTSurMois($('#TypeEmployeOk').val());
        ListTotalTotal($('#TypeEmployeOk').val());
      });

      //Quand change sprint, charge list fiches de temps / sprint
      $('#ListSrint').change(function () {
        //Si le champs est hidden, le user est un scrum master et donc on check en fonction de la list sinon par rapport a celui connecté
        if($('#ListEmpAdmin').is(":hidden")) 
          ListTotalSurSprint(localStorage.getItem("Connexion"))
        else
          ListTotalSurSprint($('#TypeEmployeOk').val())
      });

      //Quand change mois / années, charge list fiches de temps / Mois
      $('#LeMois,#LeAnnee').change(function () {
        //Si le champs est hidden, le user est un scrum master et donc on check en fonction de la list sinon par rapport a celui connecté
        if($('#ListEmpAdmin').is(":hidden")) 
        ListTotalFdTSurMois(localStorage.getItem("Connexion"))
        else
        ListTotalFdTSurMois($('#TypeEmployeOk').val())
      });

      //Liste des fonctions utilisées pour obtenir les obtenir les infos 
      function ListTotalFdTSurMois(Ressource) {
        $.ajax({
          url: "Modele/FicheDeTemps.php",
          method: "POST",
          data: {
            LaRessource: Ressource,
            LeMois: $("#LeMois option:selected").val(),
            LeAnnee: $("#LeAnnee option:selected").val(),
            action: "ListTotalSurDate"
          },
          success: function (data) {
            $('#TotRempliDate').html(data);
          }
        })
      }
      function ListTotalSurSprint(Ressource) {
        $.ajax({
          url: "Modele/FicheDeTemps.php",
          method: "POST",
          data: {
            LaRessource: Ressource,
            LeSprint: $("#numeroSprint").val(),
            action: "ListTotalSurSprint"
          },
          success: function (data) {
            $('#TotRempliSprint').html(data);
          }
        })
      }
      function ListTotalTotal(Ressource) {
        //Load total fiche de temps validé
        $.ajax({
          url: "Modele/Parametre.php",
          method: "POST",
          data: {
            action: "LoadFicheDeTempsValide",
            idRessource: Ressource
          },
          success: function (data) {
            $('#FicheValide').html(data);
          }
        });
      }
      
      //Quand change la couleur pour les taches
      $('#CouleurUser').change(function () {

        $('.BOUGEMOI').css('border-left', '5px solid ' + $('#CouleurUser').val())
        $.ajax({
          url: "Modele/Parametre.php",
          method: "POST",
          data: {
            action: "CustomColorName",
            couleur: $('#CouleurUser').val(),
            idRessource: localStorage.getItem('Connexion')
          },
          success: function (data) {
            BootstrapAlertDefaut(data);
          }
        });

      })

      //Quand cliccjk pour set le mdp
      $('#SetMdp').click(function () {

        $.ajax({
          url: "Modele/GestionTache.php",
          method: "POST",
          data: {
            ancienmdp: $('#ancienmdp').val(),
            idRessource: localStorage.getItem('Connexion'),
            action: "Checkpswd"
          },
          success: function (ancienmdpOk) {
            if ($('#mdp').val() != $('#confirmmdp').val()) {
              BootstrapAlertError('Les mots de passe ne correspondent pas.')
            } else if ($('#mdp').val().length < 5) {
              BootstrapAlertError('Un mot de passe est composé de 5 caractères minimuim')
            } else if (ancienmdpOk.trim() == "non") {
              BootstrapAlertError('Ton ancien mot de passe n\'est pas le même que celui que je connais..')
            } else {
              $.ajax({
                url: "Modele/Parametre.php",
                method: "POST",
                data: {
                  action: "Update",
                  idRessource: localStorage.getItem('Connexion'),
                  mdp: $('#mdp').val()
                },
                success: function (data) {
                  BootstrapAlertDefaut(data);
                }
              });
            }
          }
        });
      });

    });
  </script>
