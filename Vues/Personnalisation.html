<body class="fixed-nav sticky-footer" id="page-top">
  <div class="content-wrapper">
    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-4">
          <div class="card">
            <h5 class="card-header">Couleur cartes</h5>
            <div class="card-body">
              <input type="color" class="mb-3" id="CouleurUser">
              <div class="card BOUGEMOI">
                <div class="ml-2">
                  <b>
                    Prenom Nom | Projet
                    <img class="LogoProjet" src="Assets/Image/Projets/default.png"></b>
                  <p class="mb-n1">Texte de la tache</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="card">
            <h5 class="card-header">Mot de passe</h5>
            <div class="card-body">
              <div class="row">
                <div class="form-group col-lg-3">
                  <label>Ancien mot de passe</label>
                  <input type="password" class="form-control" id="ancienmdp" minlength="5" required="required">
                  <a class="d-block small text-primary mt-3" id="target" style="cursor:pointer">
                    <u>Mot de passe oublié ?</u>
                  </a>
                </div>
                <div class="form-group col-lg-3">
                  <label>Nouveau mot de passe</label>
                  <input type="password" class="form-control" id="mdp" minlength="5" required="required">
                </div>
                <div class="form-group col-lg-3">
                  <label>Confirmer</label>
                  <input type="password" class="form-control" id="confirmmdp" minlength="5" required="required">
                </div>
                <div class="form-group col-lg-3">
                  <label>Sauvegarder</label>
                  <button class="btn btn-primary" id="SetMdp">Sauvegarder</button>
                </div>
              </div>

            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <h5 class="card-header">Total des tâches validées</h5>
            <div class="card-body">
              <div id="TacheValide"></div>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card">
            <h5 class="card-header">Avatar</h5>
            <div class="card-body">
              <div class="row">
                <img style="width: 144px;height: 100%;" id="avatarUser" src="">
              </div>
              <div class="row">
                <form id="image_form" method="post" enctype="multipart/form-data">
                  <input type="file" name="image" id="image" accept="image/*" class="mb-3 d-none" />
                  <label for="image" class="customInputFile px-2 py-1"><i class="fa fa-upload" aria-hidden="true"></i>
                    Choisir un logo</label>
                  <input type="hidden" id="action" name="action" value="ChangerAvatar" />
                  <input type="submit" id="ChangerAvatar" value="Changer"
                    class="btn btn-success" />
                </form>
              </div>
            </div>

          </div>
        </div>
      </div>
    <hr>

    <h2 class="d-inline-flex mt-1">Infos fiches de temps</h2>&Tab;<label>(Les données sont enregistrées depuis Mars 2019)</label>
    <div id="ListEmpAdmin">
      <div class="form-group">
        <div id="ListEmploye"></div>
      </div>
    </div>
    <div class="row">
      <div class="col">
        <div class="card">
          <h5 class="card-header">Fiches de temps / Sprint</h5>
          <div class="card-body">
            <div class="mb-2" id="ListSrint"></div>
            <div id="TotRempliSprint"></div>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card">
          <h5 class="card-header">Fiches de temps / Date</h5>
          <div class="card-body">
            <div class="form-row">
              <div class="col">
                <input type="text" class="form-control" id="Start">
              </div>
              <div class="col">
                <input type="text" class="form-control" id="End">
              </div>
            </div>
            <div class="mt-2" id="TotRempliDate"></div>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>
  <div id="ModalOublieMdp" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Ta mémoire te fait faillite ?</h4>
        </div>
        <div class="modal-body">
          <p>N'ai crainte, oublier son mot de passe sur ScumManager n'est pas si grave, et pour cause, un scrum master a
            des pouvoirs magiques si puissants qu'il est capable de réinitialiser ton mot de passe à ses désirs. Seul
            lui a ce pouvoir car cette magie est si puissante qu'entre de mauvaises mains ce pourrait être la fin..</p>

          <img class="img-fluid" src="Assets\Image\Autre\MemeLogin.jpg"/>

        </div>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function () {

      $('#Start, #End').datetimepicker({ format: 'dd/mm/yyyy', autoclose: true, minView: 2, weekStart: 1 });
      $('#Start').val(CustomYourDate(ChoixDate(-1),'dd/mm/yyyy'));
      $('#End').val(CustomYourDate(ChoixDate(0),'dd/mm/yyyy'));


      //Affiche la modal quand oublie son mot de passe
      $("#target").click(function () {
        $('#ModalOublieMdp').modal('show');
      });

      $('#image_form').submit(function (event) {
        event.preventDefault();
        if ($('#image').val() == '') {
          $.notify(`Choisie une image d'abord`, `error`);
        } else {
          $.ajax({
            url: "Modele/GestionEmploye.php",
            method: "POST",
            data: new FormData(this),
            contentType: false,
            processData: false,
            success: function (data) {
              $('#image_form')[0].reset();
              $.notify(data, "info");
            }
          });
        }
      });

      //List de sprints généré pour pouvoir regarder les fiches de temps sur un sprint
      RequeteAjax('ListSrint', 'ListeDeroulanteSprint', 'Modele/RequetesAjax.php');

      //Charge liste heures fiche de temps sur un sprint au lancement de la page pour les différentes grilles
      ListTotalSurSprint()
      ListTotalFdtSurDate();
      GetAvatar()

      //Charge total de temps pour par projets pour les taches validées depuis les premiers logs en bdd
      $.ajax({
        url: "Modele/Parametre.php",
        method: "POST",
        data: {
          action: "LoadTacheValide"
        },
        success: function (data) {
          $('#TacheValide').html(data);
        }
      });

      $.ajax({
        url: "Modele/Parametre.php",
        method: "POST",
        data: {
          action: "GetColor"
        },
        success: function (data) {
          $('#CouleurUser').val('#' + data.split('#')[1].split(' ')[0]);
        }
      });

      function GetAvatar(){
      $.ajax({
        url: "Modele/Parametre.php",
        method: "POST",
        dataType: "json",
        data: {
          action: "GetAvatar"
        },
        success: function (data) {
          if(data.avatar == '' || data.avatar == undefined){
            $('#avatarUser').attr("src", 'Assets/Image/Ressources/default.png');
          }
          else{
          $('#avatarUser').attr("src", 'Assets/Image/Ressources/' + data.avatar);
        }
      }
      });
    }

      //Quand change sprint, charge list fiches de temps / sprint
      $('#ListSrint').change(function () {
        ListTotalSurSprint()
      });

      //Quand change mois / années, charge list fiches de temps / Mois
      $('#Start,#End').change(function () {
        ListTotalFdtSurDate()
      });

      //Liste des fonctions utilisées pour obtenir les obtenir les infos 
      function ListTotalFdtSurDate(Ressource) {
        $.ajax({
          url: "Modele/FicheDeTemps.php",
          method: "POST",
          data: {
            LaRessource: Ressource,
            Start: CustomYourDate($('#Start').val()),
            End: CustomYourDate($('#End').val()),
            action: "ListTotalSurDate"
          },
          success: function (data) {
            $('#TotRempliDate').html(data);
          }
        })
      }
      function ListTotalSurSprint() {
        $.ajax({
          url: "Modele/FicheDeTemps.php",
          method: "POST",
          data: {
            LeSprint: $("#numeroSprint").val(),
            action: "ListTotalSurSprint"
          },
          success: function (data) {
            $('#TotRempliSprint').html(data);
          }
        })
      }

      //Quand change la couleur pour les taches
      $('#CouleurUser').change(function () {

        $.ajax({
          url: "Modele/Parametre.php",
          method: "POST",
          data: {
            action: "CustomColorName",
            couleur: $('#CouleurUser').val()
          },
          success: function (data) {
            $.notify(data, "success");
          }
        });

      })

      //Quand cliccjk pour set le mdp
      $('#SetMdp').click(function () {

        $.ajax({
          url: "Modele/GestionEmploye.php",
          method: "POST",
          data: {
            ancienmdp: $('#ancienmdp').val(),
            action: "Checkpswd"
          },
          success: function (ancienmdpOk) {
            if ($('#mdp').val() != $('#confirmmdp').val()) {
              $.notify("Les mots de passe ne correspondent pas.", "error");
            } else if ($('#mdp').val().length < 5) {
              $.notify("Un mot de passe est composé de 5 caractères minimum.", "error");
            } else if (ancienmdpOk.trim() == "non") {
              $.notify("Ton ancien mot de passe n'est pas le même que celui que je connais...", "error");
            } else {
              $.ajax({
                url: "Modele/GestionEmploye.php",
                method: "POST",
                data: {
                  action: "UpdateMdpBasic",
                  mdp: $('#mdp').val()
                },
                success: function (data) {
                  $.notify(data, "success");
                }
              });
            }
          }
        });
      });

    });
  </script>