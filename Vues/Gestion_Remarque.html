<body class="fixed-nav sticky-footer" id="page-top">
  <div class="content-wrapper">
    <div class="container-fluid">

      <h3>Gestion des remarques</h3>

      <input class="form-control" id="BarreDeRecherche" type="text" placeholder="Rechercher..">

      <table class="table table-sm  table-striped table-bordered">
        <thead>
          <tr>
            <th>Créée</th>
            <th>Terminée</th>
            <th>Remarque</th>
            <th>Édition</th>
          </tr>
        </thead>
        <tbody id="TableRemarque">

        </tbody>
      </table>

    </div>
</body>

<div id="ModalRemarque" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title"></h4>
      </div>
      <div class="modal-body">

        <div class="input-group mb-3">
          <div class="input-group-prepend">
            <span class="input-group-text">Label</span>
          </div>
          <input class="form-control" id="labelRemarque" type="text">
        </div>

        <div class="input-group mb-3">
          <div class="input-group-prepend">
            <span class="input-group-text">Début</span>
          </div>
          <input type="text" id='DateDebut' class="form-control" />
        </div>

        <div class="input-group mb-3">
          <div class="input-group-prepend">
            <span class="input-group-text">Fin</span>
          </div>
          <input type="text" id='DateFin' class="form-control" />
        </div>

      </div>

      <div class="modal-footer">
        <input id="remarque_id" class="form-control" readonly/>
        <button id="EditerRemarque" class="btn btn-success">Éditer</button>
        <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {

    $('#DateDebut, #DateFin').datetimepicker({
    format: 'dd-mm-yyyy',
    autoclose: true,
    minView: 2,
    weekStart: 1
  });

    getRemarques()
    BarreDeRecherche('BarreDeRecherche', 'TableauRemarques');

    function getRemarques() {
      $.ajax({
        url: "Modele/Retrospective_Remarque.php",
        method: "POST",
        dataType: "json",
        data: {
          action: "getRemarques"
        },
        success: function (data) {

          $('#TableRemarque').html('')

          $.each(data, function () {


            var tableRemarque = $(`<tr>
                                <td>` + this.remarque_dateCreation + `</td>
                                <td>` + this.remarque_dateFini + `</td>
                                <td>` + this.remarque_label + `</td>
                              </tr>`);

            var $colloneBoutons = $('<td />');

            var $GroupBouton = $('<div class="btn-group" role="group" />');

            $GroupBouton.append($('<button type="button" id="Edit_Remarque_' + this.remarque_id +
              '" class="btn btn-warning mr-1 btn-sm"><i class="fa fa-pencil" aria-hidden="true"></i></button>'
            ).on('click', function () {
              getRemarque(this.id.split('_')[2])
            }));

            $GroupBouton.append($('<button type="button" id="Delete_Remarque_' + this.remarque_id +
              '" class="btn btn-danger btn-sm"><i class="fa fa-times" aria-hidden="true"></i></button>'
            ).on('click', function () {
              dellRemarque(this.id.split('_')[2])
            }));

            $colloneBoutons.append($GroupBouton);
            tableRemarque.append($colloneBoutons);

            $('#TableRemarque').prepend(tableRemarque)

          })
        }
      });
    }

    function getRemarque(remarque_id) {

      ShowAndClearModaleForNew('ModalRemarque', 'CreerRemarque', 'EditerRemarque')

      $.ajax({
        url: "Modele/Retrospective_Remarque.php",
        method: "POST",
        dataType: 'json',
        data: {
          remarque_id: remarque_id,
          action: "getRemarque"
        },
        success: function (data) {

          $('#ModalRemarque').modal('show');
          $('#remarque_id').val(data.RetrospectiveRemarque_id);
          $('#labelRemarque').val(data.RetrospectiveRemarque_Label);
          $('#DateDebut').val(data.RetrospectiveRemarque_DateCreation);
          $('#DateFin').val(data.RetrospectiveRemarque_DateFini);
        }
      });

    };

    $('#EditerRemarque').click(function () {
      $.ajax({
        url: "Modele/Retrospective_Remarque.php",
        method: "POST",
        data: {
          remarque_id: $('#remarque_id').val(),
          remarque_DateDebut: CustomYourDate($('#DateDebut').val()),
          remarque_DateFin: CustomYourDate($('#DateFin').val()),
          remarque_label: $('#labelRemarque').val(),
          action: 'putRemarque'
        },
        success: function (data) {
          $('#ModalRemarque').modal('hide')
          Notify(data, 'Remarque "' + $('#labelRemarque').val() + '" éditée')
          getRemarques();
        }
      });
    });

    function dellRemarque(remarque_id) {
      if (confirm("Es-tu sûr de vouloir supprimer cette remarque ?"))
        $.ajax({
          url: "Modele/Retrospective_Remarque.php",
          method: "POST",
          data: {
            remarque_id: remarque_id,
            action: "dellRemarque"
          },
          success: function (data) {
            getRemarques()
            Notify(data, 'Remarque supprimée')
          }
        })
    }
  })

</script>