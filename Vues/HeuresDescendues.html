<body class="fixed-nav sticky-footer" id="page-Result">
  <div class="content-wrapper">
    <div class="container-fluid">

      <div class="row">
        <div class="col-lg-6">
          <!-- Example Bar Chart Card-->
          <div class="card mb-3">
            <div class="card-header">
              Trier Sprint/Ressource
            </div>
            <div class="card-body">
              <!-- Selectionner le sprint sur lequel l'on va jouer -->

              <div class="input-group mb-12">
                <div class="input-group-prepend">
                  <span class="input-group-text">Sprint n°</span>
                </div>

                <div id="ListSrint"></div>
                <div class="input-group-prepend">
                  <span class="input-group-text">Ressource</span>
                </div>
                <div id="ListeEmploye"></div>

              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <!-- Example Pie Chart Card-->
          <div class="card mb-3">
            <div class="card-header">
              Valider les tâches
            </div>
            <div class="card-body">

              <div class="input-group mb-12">

                <div class="input-group-prepend">
                  <span class="input-group-text">Date</span>
                </div>
                <input type="text" name="DateAujourdhui" id='DateAujourdhui' class="form-control" />

                <button type="button" id="action" class="btn btn-info">
                  <i class="fa fa-check" aria-hidden="true"></i>&nbsp;Descendre</button>

              </div>
            </div>
          </div>
        </div>

      </div>

      <div class="row">
        <div class="col-lg-6">
          <div class="card mb-3">
            <div class="card-header">
              <center>Tâches en cours</center>
            </div>
            <div class="card-body card-columns" id=EnCours>
            </div>
          </div>
        </div>

        <div class="col-lg-6">
          <div class="card mb-3">
            <div class="card-header">
              <center>Tâches achevées</center>
            </div>
            <div class="card-body card-columns" id=Fini>
            </div>
          </div>

        </div>
      </div>
    </div>
</body>
<script>

  $(document).ready(function () {

    $('#DateAujourdhui').datetimepicker({
      format: 'dd-mm-yyyy',
      autoclose: true,
      minView: 2
    });

    RemplirListSprint('ListSrint')
    RemplirListeEmploye();
    AfficherCards();

    function AfficherCards() {
      var idAffiche = $('#numeroSprint').val();
      var idEmploye = $('#numeroEmploye').val();
      var action = "AfficherCards";
      $.ajax({
        url: "Modele/ActionDescendre.php",
        method: "POST",
        data: { action: action, idAffiche: idAffiche, idEmploye: idEmploye },
        success: function (data) {
          $('#EnCours').html(data.Attribution);
          $('#Fini').html(data.Descendue);

          var action = "DateMinMax";
          $.ajax({
            url: "Modele/ActionDescendre.php",
            method: "POST",
            data: { action: action, idAffiche: idAffiche },
            success: function (data) {
              $('#DateAujourdhui').datetimepicker('setStartDate', data['DateMin']);
              $('#DateAujourdhui').datetimepicker('setEndDate', data['DateMax']);

              if (DateFrToEn(ChoixDate(0)) >= DateFrToEn(String(data['DateMin'])) && DateFrToEn(ChoixDate(0)) <= DateFrToEn(String(data['DateMax']))) {
                console.log('Toujours dans Sprint, touche pas la date')
                $('#DateAujourdhui').val(ChoixDate(0));
              }
              else {
                console.log('aah plus dans le sprint, met la derniere date possible')
                $('#DateAujourdhui').val(data['DateMax']);
              }
              $(function () {
                $('[data-toggle="tooltip"]').tooltip()
              })
            }
          });
        }
      });
    }

    function RemplirListeEmploye() {
      var idAffiche = $('#numeroSprint').val();
      var action = "LoadListEmployes";
      $.ajax({
        url: "Modele/ActionDescendre.php",
        method: "POST",
        async: false,
        data: { action: action, idAffiche: idAffiche },
        success: function (data) {
          $('#ListeEmploye').html(data.Attribution);
          var NumEmploye = localStorage.getItem("Connexion")
          console.log(NumEmploye)
          $('#numeroEmploye option[value="' + NumEmploye + '"]').attr('selected', 'selected');
        }
      });

    }

    $('#numeroSprint').change(function () {
      RemplirListeEmploye();
      AfficherCards();
    });

    $('#ListeEmploye').change(function () {
      AfficherCards();
    });

    $('#action').click(function () {
      var action = "Descendre"
      var IdAttribue = [];
      var LeJourDeDescente = DateFrToEn($('#DateAujourdhui').val())

      $('#Fini').find(".BOUGEMOI").each(function () {
        IdAttribue.push($(this).attr('id'));
      });

      if (IdAttribue != '') {
        $.ajax({
          url: "Modele/ActionDescendre.php",
          method: "POST",
          data: { IdAttribue: IdAttribue, action: action, LeJourDeDescente: LeJourDeDescente },
          success: function (data) {
            BootstrapAlert(data);
            AfficherCards();
          }
        });
      }
      else {
        alert("Tu dois d'abord déplacer au moins une tâche de son emplacement \"en cours\" -> \"terminée.\"");
      }

    });
  });

  function DeplaceToi(id) {

    if ($(id).parent().attr('id') == 'EnCours') {
      $(id).prependTo($("#Fini"));

    }
    else {
      $(id).prependTo($("#EnCours"));
    }
  }

</script>