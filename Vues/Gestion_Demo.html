<body class="fixed-nav sticky-footer" id="page-top">
  <div class="content-wrapper">
    <div class="container-fluid">

      <h3>Gestion des démos</h3>

      <input class="form-control" id="BarreDeRecherche" type="text" placeholder="Rechercher..">

      <table class="table table-sm  table-striped table-bordered">
        <thead>
          <tr>
            <th>Fais le</th>
            <th>Ressource</th>
            <th>Projet</th>
            <th>Label</th>
            <th>Édition</th>
          </tr>
        </thead>
        <tbody id="TableDemo">

        </tbody>
      </table>

    </div>
</body>

<div id="ModalRemarque" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">Éditer remarque</h4>
      </div>
      <div class="modal-body">

        <div class="form-group">
          <label>Date effectuée</label>
          <input type="text" name="DateEffectue" id='DateEffectue' class="form-control" />
        </div>

        <div class="form-group">
          <label>Ressource</label>
          <div id="ListEmploye"></div>
        </div>

        <div id="leProjet" class="form-group">
          <label>Projet</label>
          <div name="ListProjet" id="ListProjet"></div>
        </div>

        <div class="form-group">
          <label>Label démo</label>
          <input type="text" name="LabelDemo" id="LabelDemo" class="form-control" />
        </div>

      </div>

      <div class="modal-footer">
        <input class="form-control" name="id" id="id" readonly/>
        <input type="submit" name="action" id="putDemo" class="btn btn-success" />
        <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {

    $('#DateEffectue').datetimepicker({
    format: 'dd-mm-yyyy',
    autoclose: true,
    minView: 2,
    weekStart: 1
  });

    getDemos();

    RequeteAjax('ListEmploye', 'ListeDeroulanteEmploye', 'Modele/RequetesAjax.php');
    RequeteAjax('ListProjet', 'ListeDeroulanteProjet', 'Modele/RequetesAjax.php', 'ProjetDemo');
    BarreDeRecherche('BarreDeRecherche', 'TableauDemo');

    function getDemos() {
      // Remplir la liste des démos
      $.ajax({
        url: "Modele/Retrospective_demo.php",
        method: "POST",
        dataType: "json",
        data: {
          action: "getDemos"
        },
        success: function (data) {
          console.log(data)

          $('#TableDemo').html('')

          $.each(data, function () {

            var tableDemos = $(`<tr>
                                <td>` + this.demo_DateEffectue + `</td>
                                <td>` + this.ressource_prenom + ` ` + this.ressource_initial + `</td>
                                <td>` + this.projet_nom + `</td>
                                <td>` + this.demo_label + `</td>
                              </tr>`);

            var $colloneBoutons = $('<td />');

            var $GroupBouton = $('<div class="btn-group" role="group" />');

            $GroupBouton.append($('<button type="button" id="Edit_Demo_' + this.demo_id +
              '" class="btn btn-warning btn-sm"><i class="fa fa fa-pencil" aria-hidden="true"></i></button>'
            ).on('click', function () {
              getDemo(this.id.split('_')[2])
            }));

            $GroupBouton.append($('<button type="button" id="Delete_Demo_' + this.demo_id +
              '" class="btn btn-danger btn-sm"><i class="fa fa-times" aria-hidden="true"></i></button>'
            ).on('click', function () {
              dellDemo(this.id.split('_')[2])
            }));

            $colloneBoutons.append($GroupBouton);
            tableDemos.append($colloneBoutons);

            $('#TableDemo').prepend(tableDemos)

          })

        },

      });
    }

    function getDemo(demo_id) {

      $.ajax({
        url: "Modele/Retrospective_demo.php",
        method: "POST",
        data: {
          demo_id: demo_id,
          action: "getDemo"
        },
        dataType: "json",
        success: function (data) {

          $('#ModalRemarque').modal('show');
          $('#id').val(data.demo_id);
          $('#employeId').val(data.demo_id_Employe);
          $('#ProjetDemo').val(data.demo_id_Projet);
          $('#LabelDemo').val(data.demo_Label);
          $('#DateEffectue').val(DateFrToEn(data.demo_DateEffectue));

          $("#ProjetDemo, #employeId").select2({
            width: "100%"
          });


        }
      });

    }

    function dellDemo(demo_id) {

      if (confirm("Es-tu sûr de vouloir supprimer cette remarque ?"))
        $.ajax({
          url: "Modele/Retrospective_demo.php",
          method: "POST",
          data: {
            demo_id: demo_id,
            action: "dellDemo"
          },
          success: function (data) {
            Notify(data,'Démo supprimée')
            getDemos();
          }
        });

    }

    $('#putDemo').bind( "click", function() {

      $.ajax({
        url: "Modele/Retrospective_demo.php",
        method: "POST",
        data: {
          id: $('#id').val(),
          Employe: $('#employeId').val(),
          Projet: $('#ProjetDemo').val(),
          LabelDemo: $('#LabelDemo').val(),
          DateEffectue: DateFrToEn($('#DateEffectue').val()),
          action: "putDemo"
        },
        success: function (data) {
          Notify(data,'Démo mise à jour')
          $('#ModalRemarque').modal('hide');
          getDemos()
        }
      });
    });

  });

  
</script>