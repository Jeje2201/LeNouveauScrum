<body class="fixed-nav sticky-footer" id="page-top">
  <div class="content-wrapper">
    <div class="container-fluid">

      <div class="card">
        <div class="card-header">
          <b>Remplir ses feuilles de temps</b>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col">
              <div class="form-group">
                <label>Projets / Activit√©s</label>
                <div name="ListProjet" id="ListProjet"></div>
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label>Date d√©but</label>
                <input type="text" class="form-control" id="StartDate">
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label>Date Fin</label>
                <input type="text" class="form-control" id="EndDate">
              </div>
            </div>
              <div class="col">
                <label>Heures (Custom Style By J√©r√©my üëå)</label>
                  <input type="range" id="LeSliderDesHeures" value="0.25" min="0.25" max="7" step="0.25" />
                  <label id="InfosRangeHeures"></label> / <label id="InfosRangeHeuresMax"></label>
              </div>
              
              <div class="col">
                  <div class="form-group">
                    <label>Valider</label>
                    <button type="button" id="SetFicheDeTemps" class="btn btn-success btn-block">Envoyer</button>
                  </div>
                </div>
          </div>
        </div>
      </div>
      <br>
      <div class="row">
        <div class="col-lg-6">
          <div id="TableTotAujourdhui"></div>
        </div>
        <div class="col-lg-6">
          <div id="TableTotJoursNonPlein"></div>
        </div>
      </div>
      <div class="centered" id="RetardEnGeneral"> <i class="fa fa-spin fa-3x fa-fw">üòÆ</i></div>

    </div>
  </div>


  <div id="ModalProblemeDate" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Ah non, je t'arr√™te de suite!</h4>
        </div>
        <div class="modal-body">
          <p>Pour faire simple, dans ta liste de dates que tu as s√©lectionn√©, certaines dates auraient plus d'1 jour si on additionne ta valeur avec celles dont elles sont d√©j√† compos√©es, pour le CIR, une journ√©e, c'est pas plus que 7h.</p>
          <p>Je suis gentil (üòä) alors voici la liste des dates qui posent probl√®me :</p>
          <p id="ListeDateAvecUnProbleme"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function () {

      InfoMaxSlider();

      //On informe le texte de range combien vaut la range
      $('#InfosRangeHeures').html( Math.trunc($('#LeSliderDesHeures').val()) + ' h ' + ($('#LeSliderDesHeures').val() - Math.floor($('#LeSliderDesHeures').val())) * 60);   

      //Date d'aujourd'hui
      $('#StartDate, #EndDate').val(ChoixDate(0));
      $('#StartDate, #EndDate').datetimepicker({format: 'dd-mm-yyyy', autoclose: true, minView: 2 , weekStart: 1});

      //Charger liste projets
      RequeteAjax('ListProjet', 'ListeDeroulanteProjetAvecCir', 'Modele/RequetesAjax.php');
      SetSelect2('#projetId');

      //Charger liste
      ChargerListeHeures1Jour1Ressource()

      TableTotJoursNonPlein()

      //Si ne reconnait pas l'utilisateur, le rediriger vers la connexion
      if (!localStorage.getItem("Connexion")) {
        $('.container-fluid').html("<h1>Erreur de cache</h1>Je ne reconnais pas qui tu es. Peut-tu te connecter √† nouveau en cliquand <a href='Modele/ConnectionLogout.php'>ICI</a> ?")
      }

      $('#StartDate').change(function () {
        ChargerListeHeures1Jour1Ressource()
        $('#EndDate').val($('#StartDate').val())
      });

      //Quand bouge slider
      $(document).on('input', '#LeSliderDesHeures', function() {

        $('#InfosRangeHeures').html( Math.trunc($(this).val()) + ' h ' + ($(this).val() - Math.floor($(this).val())) * 60);   

      });

      //Add les infos
      $('#SetFicheDeTemps').click(function () {

          $.ajax({
            url: "Modele/FicheDeTemps.php",
            method: "POST",
            dataType: "json",
            data: {
              action: "Create",
              Ressource: localStorage.getItem("Connexion"),
              Projet: $('#projetId').val(),
              Time: $('#LeSliderDesHeures').val(),
              Done: ListeJoursDate($('#StartDate').val(), $('#EndDate').val()),
              Log: DateFrToEn(ChoixDate(0))
            },
            success: function (data) {
              console.log(data)
              if((data.Liste).length > 0){
                $('#ListeDateAvecUnProbleme').html(data.Texte)
                $('#ModalProblemeDate').modal('show');
              }
              else{
                ChargerListeHeures1Jour1Ressource()
                TableTotJoursNonPlein()
                BootstrapAlertDefaut('‚úì');
                InfoMaxSlider()
              }
            }
          });
      });

      //Partie pour informer le max du slider
      function InfoMaxSlider() {
        var LaDate = DateFrToEn($('#StartDate').val())

        if ($('#StartDate').val() == "") 
          LaDate = DateFrToEn(ChoixDate(0))

        $.ajax({
          url: "Modele/FicheDeTemps.php",
          method: "POST",
          dataType: "json",
          data: {
            action: "LimitSlider",
            Ressource: localStorage.getItem("Connexion"),
            Done: LaDate
          },
          success: function (data) {
            console.log(data)
            $('#InfosRangeHeuresMax').html( Math.trunc(data) + ' h ' + (data - Math.floor(data)) * 60); 
          }
        })
      }

      //Charger les infos
      function ChargerListeHeures1Jour1Ressource() {

        var LaDate = DateFrToEn($('#StartDate').val())

        if ($('#StartDate').val() == "") 
          LaDate = DateFrToEn(ChoixDate(0))

        $.ajax({
          url: "Modele/FicheDeTemps.php",
          method: "POST",
          data: {
            action: "LoadHeuresRempli1Jour1Ressource",
            Done: LaDate,
            LaRessource: localStorage.getItem("Connexion")
          },
          success: function (data) {
            $('#TableTotAujourdhui').html(data);
          }
        });
      }

      //Supprimer une fiche de temps
      $(document).on('click', '.delete', function () {
        if (confirm("Es-tu s√ªr de vouloir supprimer cette donn√©e ?")) 
          $.ajax({
            url: "Modele/FicheDeTemps.php",
            method: "POST",
            data: {
              id: $(this).attr("id"),
              action: "Delete"
            },
            success: function (data) {
              ChargerListeHeures1Jour1Ressource()
              TableTotJoursNonPlein()
              BootstrapAlertDefaut(data);
              InfoMaxSlider();
            }
          })
      });

      //Load la liste des fiches de temps non rempli + fonction pour update la date s√©lectionn√© quand click sur une date de la liste
      function TableTotJoursNonPlein() {
        $.ajax({
          url: "Modele/FicheDeTemps.php",
          method: "POST",
          data: {
            LaRessource: localStorage.getItem("Connexion"),
            action: "TableTotJoursNonPlein"
          },
          success: function (data) {
            $('#TableTotJoursNonPlein').html(data);

            let elementsArray = document.querySelectorAll(".ListeDateManquante");

            elementsArray.forEach(function(elem) {
                elem.addEventListener("click", function() {
                  $('#StartDate, #EndDate').val(elem.textContent.replace(/\//g, "-"))
                  ChargerListeHeures1Jour1Ressource()
                });
            });
          }
        })
      }

      $.ajax({
    url: "Modele/FicheDeTemps.php",
    method: "POST",
    data: {
      action: "RetardEnGeneral"
    },
    success: function (data) {

      if (IsJsonString(data))
        data = JSON.parse(data);

      Highcharts.chart('RetardEnGeneral', {
        chart: {
          type: 'column'
        },
        title: {
          text: 'Nombre de feuilles de temps non remplies par ressources'
        },
        xAxis: {
          type: 'category',
          categories: data['NomUser'],
          labels: {
            rotation: -45,
            style: {
              fontSize: '15px',
              fontFamily: 'Verdana, sans-serif'
            }
          }
        },
        yAxis: {
          min: 0,
          title: {
            text: 'feuilles de temps non remplies'
          }
        },
        tooltip: {
          shared: true,
        },
        plotOptions: {
          column: {
            stacking: 'normal',
            grouping: false,
            shadow: true,
            borderWidth: 1
          },
          dataLabels: {
            enabled: true,
            format: ''
          }
        },
        series: [
          {
            name: 'feuilles de temps non remplies',
            data:  data['NbDatePerUser'],
            stack: 0,
            pointPadding: 0.3,
          }
        ]
      });
    }
  });

    });
  </script>