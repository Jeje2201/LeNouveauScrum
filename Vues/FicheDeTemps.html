<body class="fixed-nav sticky-footer" id="page-top">
  <div class="content-wrapper">
    <div class="container-fluid">

      <div class="card">
        <div class="card-header">
          <b>Remplir ses feuilles de temps</b>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col">
              <div class="form-group">
                <label>Projets / Activit√©s</label>
                <div name="ListProjet" id="ListProjet"></div>
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label>Date d√©but</label>
                <input type="text" class="form-control" id="StartDate">
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label>Date Fin</label>
                <input type="text" class="form-control" id="EndDate">
              </div>
            </div>
            <div class="col">
              <label>Heures (version J)</label>
              <div class="form-group">
                <div class="btn-group btn-block" role="group">
                  <button type="button" id="ShortcutHours" class="btn btn-info"> 0.25 </button>
                  <button type="button" id="ShortcutHours" class="btn btn-info"> 0.5 </button>
                  <button type="button" id="ShortcutHours" class="btn btn-info"> 0.75 </button>
                  <button type="button" id="ShortcutHours" class="btn btn-info"> 1 </button>
                  <!-- <button type="button" id="ShortcutHours" class="btn btn-info"> Max </button> -->
                </div>
              </div>
            </div>
            <div class="col">
              <label>Heures</label>
              <div class="input-group">

                <input type="number" id="HeureFdt" value="0" min="0" class="form-control">
                <div class="input-group-prepend">
                  <span class="input-group-text" id="">H</span>
                </div>
                <input type="number" id="MinuteFdt" value="0" class="form-control" min="0">

              </div>
            </div>
            <div class="col">
              <label id="InfosTempsFdt"></label>
              <div class="progress"  style="height: 35px;">
                <div class="progress-bar" role="progressbar" aria-valuenow="84" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>

            <div class="col">
              <div class="form-group">
                <label>Valider</label>
                <button type="button" id="SetFicheDeTemps" class="btn btn-success btn-block">Envoyer</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <br>
      <div class="row">
        <div class="col-lg-6">
          <div id="TableTotAujourdhui"></div>
        </div>
        <div class="col-lg-6">
          <div id="TableTotJoursNonPlein"></div>
        </div>
      </div>
      <div class="centered" id="RetardEnGeneral">
        <i class="fa fa-spin fa-3x fa-fw">üòÆ</i>
      </div>

    </div>
  </div>

  <div id="ModalProblemeDate" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Ah non, je t'arr√™te de suite!</h4>
        </div>
        <div class="modal-body">
          <p>Pour faire simple, dans ta liste de dates que tu as s√©lectionn√©, certaines dates auraient plus d'1 jour si on additionne ta valeur avec celles dont elles sont d√©j√† compos√©es, pour le CIR, une journ√©e, c'est pas plus que <b>7h7h24</b>.</p>
          <p>Je suis gentil (üòä) alors voici la liste des dates qui posent probl√®me :</p>
          <p id="ListeDateAvecUnProbleme"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function () {

      //Date d'aujourd'hui
      $('#StartDate, #EndDate').val(ChoixDate(0));
      $('#StartDate, #EndDate').datetimepicker({format: 'dd-mm-yyyy', autoclose: true, minView: 2, weekStart: 1});

      InfoMaxSlider()

      //Charger liste projets
      RequeteAjax('ListProjet', 'ListeDeroulanteProjetAvecCir', 'Modele/RequetesAjax.php');
      SetSelect2('#projetId');

      //Charger liste
      ChargerListeHeures1Jour1Ressource()

      TableTotJoursNonPlein()

      //Lorsque change la date de debut
      $('#StartDate').change(function () {
        ChargerListeHeures1Jour1Ressource()
        $('#EndDate').val($('#StartDate').val())
        InfoMaxSlider()
      });

      //Add les infos
      $('.btn-info').click(function () {
        // alert($(this).text()*444);
        $('#HeureFdt').val(MinutesIntoTime($(this).text()*444,'heure'))
        $('#MinuteFdt').val(MinutesIntoTime($(this).text()*444,'minute'))
      })

      //Convert minutes into hours and min
      function MinutesIntoTime(n,result) {
        var num = n;
        var hours = (num / 60);
        var rhours = Math.floor(hours);
        var minutes = (hours - rhours) * 60;
        var rminutes = Math.round(minutes);

        if(rhours < 10)
          rhours = "0"+rhours

        if(rminutes < 10)
          rminutes = "0"+rminutes

        if(result == 'minute')
          return rminutes;
        if(result == 'heure')
          return rhours;
        if(result == 'more')
          return rhours + ' h ' + rminutes;
      }

      function InfoMaxSlider(){
        $.ajax({
          url: "Modele/FicheDeTemps.php",
          method: "POST",
          dataType: "json",
          data: {
            action: "GetNewMax",
            Ressource: localStorage.getItem("Connexion"),
            Done: DateFrToEn($('#StartDate').val())
          },
          success: function (data) {
            $('#InfosTempsFdt').text('Il manque: '+MinutesIntoTime(444-data,'more'))
            $('.progress-bar').text(Math.trunc(data/444*100)+' %').css("width", Math.trunc(data/444*100)+'%')

            if(Math.trunc(data/444*100) < 100 ){
            $('.progress-bar').removeClass('bg-success')
            $('.progress-bar').addClass('bg-danger')
            } else{
            $('.progress-bar').removeClass('bg-danger')
            $('.progress-bar').addClass('bg-success')
            }
          }
        });
      }

      //Add les infos
      $('#SetFicheDeTemps').click(function () {

        if(parseInt($('#HeureFdt').val()*60)+parseInt($('#MinuteFdt').val()) == 0){
          BootstrapAlertError('0 ? Je crois pas non üôÉ')
          return false;
        }

        $.ajax({
          url: "Modele/FicheDeTemps.php",
          method: "POST",
          dataType: "json",
          data: {
            action: "Create",
            Ressource: localStorage.getItem("Connexion"),
            Projet: $('#projetId').val(),
            Time: parseInt($('#HeureFdt').val()*60)+parseInt($('#MinuteFdt').val()),
            Done: ListeJoursDate($('#StartDate').val(), $('#EndDate').val()),
            Log: DateFrToEn(ChoixDate(0))
          },
          success: function (data) {
            console.log(data)
            if ((data.Liste).length > 0) {
              $('#ListeDateAvecUnProbleme').html(data.Texte)
              $('#ModalProblemeDate').modal('show');
            } else {
              ChargerListeHeures1Jour1Ressource()
              TableTotJoursNonPlein()
              BootstrapAlertDefaut('‚úì');
              InfoMaxSlider()
            }
          }
        });
      });

      //Charger les infos
      function ChargerListeHeures1Jour1Ressource() {

        var LaDate = DateFrToEn($('#StartDate').val())

        if ($('#StartDate').val() == "") 
          LaDate = DateFrToEn(ChoixDate(0))

        $.ajax({
          url: "Modele/FicheDeTemps.php",
          method: "POST",
          data: {
            action: "LoadHeuresRempli1Jour1Ressource",
            Done: LaDate,
            LaRessource: localStorage.getItem("Connexion")
          },
          success: function (data) {
            $('#TableTotAujourdhui').html(data);
          }
        });
      }

      //Supprimer une fiche de temps
      $(document).on('click', '.delete', function () {
        if (confirm("Es-tu s√ªr de vouloir supprimer cette donn√©e ?")) 
          $.ajax({
            url: "Modele/FicheDeTemps.php",
            method: "POST",
            data: {
              id: $(this).attr("id"),
              action: "Delete"
            },
            success: function (data) {
              ChargerListeHeures1Jour1Ressource()
              TableTotJoursNonPlein()
              BootstrapAlertDefaut(data);
              InfoMaxSlider();
            }
          })
      });

      //Load la liste des fiches de temps non rempli + fonction pour update la date s√©lectionn√© quand click sur une date de la liste
      function TableTotJoursNonPlein() {
        $.ajax({
          url: "Modele/FicheDeTemps.php",
          method: "POST",
          data: {
            LaRessource: localStorage.getItem("Connexion"),
            action: "TableTotJoursNonPlein"
          },
          success: function (data) {
            $('#TableTotJoursNonPlein').html(data);

            let elementsArray = document.querySelectorAll(".ListeDateManquante");

            elementsArray.forEach(function (elem) {
              elem.addEventListener("click", function () {
                $('#StartDate, #EndDate').val(elem.textContent.replace(/\//g, "-"));
                ChargerListeHeures1Jour1Ressource();
                InfoMaxSlider();
              });
            });
          }
        })
      }

      $.ajax({
        url: "Modele/FicheDeTemps.php",
        method: "POST",
        data: {
          action: "RetardEnGeneral"
        },
        success: function (data) {

          if (IsJsonString(data)) 
            data = JSON.parse(data);
          
          Highcharts.chart('RetardEnGeneral', {
            chart: {
              type: 'column'
            },
            title: {
              text: 'Nombre de feuilles de temps non remplies par ressources'
            },
            xAxis: {
              type: 'category',
              categories: data['NomUser'],
              labels: {
                rotation: -45,
                style: {
                  fontSize: '15px',
                  fontFamily: 'Verdana, sans-serif'
                }
              }
            },
            yAxis: {
              min: 0,
              title: {
                text: 'feuilles de temps non remplies'
              }
            },
            tooltip: {
              shared: true
            },
            plotOptions: {
              column: {
                stacking: 'normal',
                grouping: false,
                shadow: true,
                borderWidth: 1
              },
              dataLabels: {
                enabled: true,
                format: ''
              }
            },
            series: [
              {
                name: 'feuilles de temps non remplies',
                data: data['NbDatePerUser'],
                stack: 0,
                pointPadding: 0.3
              }
            ]
          });
        }
      });

    });
  </script>