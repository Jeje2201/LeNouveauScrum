<body class="fixed-nav sticky-footer" id="page-top">
  <div class="content-wrapper">
    <div class="container-fluid">

      <div class="card">
        <div class="card-header">
          <b>Remplir ses feuilles de temps</b>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col">
              <div class="form-group">
                <label>Projets&nbsp;/&nbsp;Activit√©s</label>
                <div id="ListProjet"></div>
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label>D√©but</label>
                <input type="text" class="form-control" id="StartDate">
              </div>
            </div>
            <div class="col">
              <div class="form-group">
                <label>Fin</label>
                <input type="text" class="form-control" id="EndDate">
              </div>
            </div>
            <div class="col">
              <label>Temps</label>
              <div class="form-group">
                <div class="btn-group btn-block" role="group">
                  <button type="button" id="ShortcutHours" value="01:51" class="btn btn-info">
                    25%
                  </button>
                  <button type="button" id="ShortcutHours" value="03:42" class="btn btn-info">
                    50%
                  </button>
                  <button type="button" id="ShortcutHours" value="05:33" class="btn btn-info">
                    75%
                  </button>
                  <button type="button" id="ShortcutHours" value="07:24" class="btn btn-info">
                    100%
                  </button>
                  <button type="button" id="ShortcutHours" value="22:22" class="btn btn-info">
                    Max
                  </button>
                </div>
              </div>
            </div>
            <div class="col">
              <label>Temps</label>
              <input type="time" id="TempsFdt" value="00:00" class="form-control">
            </div>
            <div class="col">
              <label>Il&nbsp;manque&nbsp;</label><span id="InfosTempsFdt"></span>
              <div class="progress" style="height: 35px;">
                <div class="progress-bar" role="progressbar" aria-valuenow="84" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>

            <div class="col">
              <div class="form-group">
                <label>&nbsp;</label>
                <button type="button" id="SetFicheDeTemps" class="btn btn-success btn-block">Envoyer</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      <br>

      <div class="row">

        <div class="col">
          <div id="TableTotAujourdhui"></div>
        </div>

        <div class="col">
          <table class="table table-sm  table-striped table-bordered">
            <thead>
              <tr>
                <th>Date manquante</th>
              </tr>
            </thead>
            <tbody id="TableTotJoursNonPlein">
    
            </tbody>
          </table>
        </div>
      </div>


      <div class="centered" id="RetardEnGeneral">
        <i class="fa fa-spin fa-3x fa-fw mt-5">._.</i>
      </div>

    </div>
  </div>

  <div id="ModalProblemeDate" class="modal fade">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Ah non, je t'arr√™te de suite!</h4>
        </div>
        <div class="modal-body">
          <p>Pour faire simple, dans ta liste de dates que tu as s√©lectionn√©, certaines dates auraient plus d'1 jour si on additionne ta valeur avec celles dont elles sont d√©j√† compos√©es, pour le CIR, une journ√©e, c'est pas plus que
            <b>7h24</b>.</p>
          <p>Je suis gentil (üòä) alors voici la liste des dates qui posent probl√®me :</p>
          <p id="ListeDateAvecUnProbleme"></p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" data-dismiss="modal">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function () {

      //Date d'aujourd'hui
      $('#StartDate, #EndDate').val(ChoixDate(0));
      $('#StartDate, #EndDate').datetimepicker({format: 'dd-mm-yyyy', autoclose: true, minView: 2, weekStart: 1});

      InfoMaxSlider()

      //Charger liste projets
      RequeteAjax('ListProjet', 'ListeDeroulanteProjetAvecCir', 'Modele/RequetesAjax.php');
      $("#projetId" ).select2({width: "100%"});

      //Charger liste
      ChargerListeHeures1Jour1Ressource()
      ChartBatonTotJoursNonPlein()
      TableTotJoursNonPlein()

      //Lorsque change la date de debut

      $('#StartDate').change(function () {
        ChargerListeHeures1Jour1Ressource()
        $('#EndDate').val($('#StartDate').val())
        InfoMaxSlider()
      });

      //Add les infos
      $('.btn-info').click(function () {

        if($(this).val() == '22:22'){
          $('#TempsFdt').val($('#InfosTempsFdt').text().replace('h',':'))
        }else{
          $('#TempsFdt').val($(this).val())
        }

      })

      //Convert minutes into hours and min
      function MinutesIntoTime(n) {
        var num = n;
        var hours = (num / 60);
        var rhours = Math.floor(hours);
        var minutes = (hours - rhours) * 60;
        var rminutes = Math.round(minutes);

        if (rhours < 10) 
          rhours = "0" + rhours

        if (rminutes < 10) 
          rminutes = "0" + rminutes

        return rhours + 'h' + rminutes;
        }
      
      function InfoMaxSlider() {
        $.ajax({
          url: "Modele/FicheDeTemps.php",
          method: "POST",
          dataType: "json",
          data: {
            action: "GetNewMax",
            Done: DateSwitch($('#StartDate').val())
          },
          success: function (data) {
            $('#InfosTempsFdt').text(MinutesIntoTime(444 - data))
            $('.progress-bar')
              .text(Math.trunc(data / 444 * 100) + ' %')
              .css("width", Math.trunc(data / 444 * 100) + '%')

            if (Math.trunc(data / 444 * 100) < 100) {
              $('.progress-bar').removeClass('bg-success')
              $('.progress-bar').addClass('bg-danger')
            } else {
              $('.progress-bar').removeClass('bg-danger')
              $('.progress-bar').addClass('bg-success')
            }
          }
        });
      }

      //Add les infos
      $('#SetFicheDeTemps').click(function () {

        if (parseInt($('#TempsFdt').val().split(':')[0] * 60) + parseInt($('#TempsFdt').val().split(':')[1]) > 444 || parseInt($('#TempsFdt').val().split(':')[0] * 60) + parseInt($('#TempsFdt').val().split(':')[1]) == 0) {
          $.notify("Le temps ne peut pas √™tre inf√©rieure √† 00:01 et sup√©rieure √† 07:24", "error");
          return false;
        }

        $.ajax({
          url: "Modele/FicheDeTemps.php",
          method: "POST",
          dataType: "json",
          data: {
            action: "addFicheDeTemps",
            Projet: $('#projetId').val(),
            Time: parseInt($('#TempsFdt').val().split(':')[0] * 60) + parseInt($('#TempsFdt').val().split(':')[1]),
            Done: ListeJoursDate($('#StartDate').val(), $('#EndDate').val()),
            Log: DateSwitch(ChoixDate(0))
          },
          success: function (data) {
            if ((data.Liste).length > 0) {
              $('#ListeDateAvecUnProbleme').html(data.Texte)
              $('#ModalProblemeDate').modal('show');
            } else {
              ChargerListeHeures1Jour1Ressource()
              ChartBatonTotJoursNonPlein()
              TableTotJoursNonPlein()
              $.notify("Fiche de temps cr√©√©e avec succ√®s", "success");
              InfoMaxSlider()
            }
          }
        });
      });

      //Charger les infos
      function ChargerListeHeures1Jour1Ressource() {

        var LaDate = DateSwitch($('#StartDate').val())

        if ($('#StartDate').val() == "") 
          LaDate = DateSwitch(ChoixDate(0))

        $.ajax({
          url: "Modele/FicheDeTemps.php",
          method: "POST",
          data: {
            action: "LoadHeuresRempli1Jour1Ressource",
            Done: LaDate
          },
          success: function (data) {
            $('#TableTotAujourdhui').html(data);
          }
        });
      }

      //Supprimer une fiche de temps
      $(document).on('click', '.delete', function () {
        if (confirm("Es-tu s√ªr de vouloir supprimer cette donn√©e ?")) 
          $.ajax({
            url: "Modele/FicheDeTemps.php",
            method: "POST",
            data: {
              id: $(this).attr("id"),
              action: "Delete"
            },
            success: function (data) {
              ChargerListeHeures1Jour1Ressource()
              ChartBatonTotJoursNonPlein()
              TableTotJoursNonPlein()
              $.notify(data, "success");
              InfoMaxSlider();
            }
          })
      });

      

      //Load la liste des fiches de temps non rempli + fonction pour update la date s√©lectionn√© quand click sur une date de la liste
      function TableTotJoursNonPlein() {
        $.ajax({
          url: "Modele/FicheDeTemps.php",
          method: "POST",
          dataType: "json",
          data: {
            action: "TableTotJoursNonPlein"
          },
          success: function (data) {
            
            //Je set mon tableau de toutes les dates enregistr√©s de {0:... fichedescendue:...} en juste [fichedescendue...,fichedescendue..]
            i=0
            data.forEach(element => {
            
              data[i] = data[i].fiche_de_temps_done
              i+=1  
            })

            //Je cr√©er une variable "dates" qui va prendre toutes les jours sauf weekend depuis que la ressource arrive et les √©crit comme le tableau precedent YYYY-MM-JJ
            var dates = new Array,
            currentDate = new Date("<?php print($_SESSION['user']['registerDate'] )?>"),
            today = new Date()
            addDays = function(days) {
              var date = new Date(this.valueOf());
              date.setDate(date.getDate() + days);
              return date;
            };
            while (currentDate <= today) {
              if(currentDate.getDay() != 0 && currentDate.getDay() != 6){
                dates.push(new Date(currentDate.getTime() - (currentDate.getTimezoneOffset() * 60000 )).toISOString().split("T")[0]);
              }
              currentDate = addDays.call(currentDate, 1);
            }

            $('#TableTotJoursNonPlein').html('')

            //Pours chaques jours qui existent depuis l'arriv√© de la ressource et minimum en mars 2019 car quand commence log les fiches de temps, si parmis tous ces jours, il y a des jours qu'on ne retrouve pas en comparant avec ceux remplis alors c'est qu'ils ne sont aps rempli et on les affiche
            i = 0
            dates.forEach(element => {
              if(!data.includes(element)){
                console.log(element)
                $('#TableTotJoursNonPlein').prepend($(`<tr><td>` + DateSwitch(element) + `</td></tr>`).on('click', function () {
              $('#StartDate, #EndDate').val(DateSwitch(element));
                ChargerListeHeures1Jour1Ressource();
                InfoMaxSlider();
            }))
              }
              i+=1
            });
            IfNoRows("TableTotJoursNonPlein")

          }
          
        })
      }
    function ChartBatonTotJoursNonPlein() {
      $.ajax({
        url: "Modele/FicheDeTemps.php",
        method: "POST",
        dataType: "json",
        data: {
          action: "RetardEnGeneral"
        },
        success: function (data) {

            LeNomUser = new Array
            LeNomUser = data['NomUser']

            RegsiterDate = new Array
            RegsiterDate = data['RegsiterDate']

            NbDateRemplis = new Array
            NbDateRemplis = data['NbDatePerUser']

            //NbDataRemplis = nombre de fdt remplus, pour chaques user, on check le nb de jours qu'il doit remplir ses feuilles NbJourDeTravai() moins le nombre qu'il a d√©j√† remplis pour savoir combien il doit encore remplir
            i=0
            NbDateRemplis.forEach(element => {
              NbDateRemplis[i] = NbJourDeTravail(RegsiterDate[i],ChoixDate(0))-element+1
              i+=1
            });

             //1) combine the arrays:
             var list = [];
            for (var j = 0; j < NbDateRemplis.length; j++) 
                list.push({'NbDateRemplis': NbDateRemplis[j], 'LeNomUser': LeNomUser[j], 'RegsiterDate': RegsiterDate[j]});

            //2) sort:
            list.sort(function(a, b) {
                return ((a.NbDateRemplis > b.NbDateRemplis) ? -1 : ((a.NbDateRemplis == b.NbDateRemplis) ? 0 : 1));
                //Sort could be modified to, for example, sort on the LeNomUser 
                // if the NbDateRemplis is the same.
            });

            //3) separate them back out:
            for (var k = 0; k < list.length; k++) {
                NbDateRemplis[k] = list[k].NbDateRemplis;
                LeNomUser[k] = list[k].LeNomUser;
                RegsiterDate[k] = list[k].RegsiterDate;
            }
          
          Highcharts.chart('RetardEnGeneral', {
            chart: {
              type: 'column'
            },
            title: {
              text: 'Nombre de feuilles de temps non remplies par ressources'
            },
            xAxis: {
              type: 'category',
              categories: LeNomUser,
              labels: {
                rotation: -45,
                style: {
                  fontSize: '15px',
                  fontFamily: 'Verdana, sans-serif'
                }
              }
            },
            yAxis: {
              min: 0,
              title: {
                text: 'feuilles de temps non remplies'
              }
            },
            tooltip: {
              shared: true
            },
            plotOptions: {
              column: {
                stacking: 'normal',
                grouping: false,
                shadow: true,
                borderWidth: 1
              },
              dataLabels: {
                enabled: true,
                format: ''
              }
            },
            series: [
              {
                name: 'feuilles de temps non remplies',
                data: NbDateRemplis,
                stack: 0,
                pointPadding: 0.3,
                zones: [{
                  value: 7,
                  color: '#7CB5EC' 
                },{
                  color: 'red'
                }]
              }
            ]
          });
        }
      });
    }
    });
  </script>
