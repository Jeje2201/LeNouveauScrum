<body class="fixed-nav sticky-footer" id="page-top">
  <div class="content-wrapper">
    <div class="container-fluid">

      <div class="row">
        <div class="col">
          <div id="ListSrint"></div>
        </div>
        <div class="col">
          <button  id="Boutton_Modal_ApiPivotal" class="btn btn-block btn-info">Planification</button>
        </div>
        <div class="col">
          <button  id="ButtonScrumPlaning" class="btn btn-block btn-info"
            onclick="$('#ModalScrumPlaning').modal('show');">Non projet</button>
        </div>

      </div>
      <div class="row">
        <div class="col-lg-12">
          <input class="form-control" id="BarreDeRecherche" type="text" placeholder="Rechercher..">
        </div>
      </div>
      <div class="row">
        <div class="col-lg-12">

          <div id="TableListHeuresAttribuees" class="table-responsive table-hover"></div>

        </div>
      </div>
    </div>

<div id="ModalApi" class="modal fade">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-body">
        <div class="FollowAttribuable text-center">
          <div id="totalheure"></div>
          <button type="submit" id="EnvoyerApiPivotal" class="btn btn-block btn-success">Attribuer</button>
        </div>
        <div class="row">
          <div class="hideElement">
            <label>Ressource</label>
            <input type="text" class="form-control" id="ListEmployePivotal" disabled>
          </div>

          <div class="col">
            <label>Projet</label>
            <div id="ListProjetPivotal"></div>
          </div>
        </div>

        <hr class="my-3">

        <button class="accordion">Planification manuelle</button>
        <div class="panel">

        <div class="row mb-4">
          <div class="col-lg-9">
            <input class="form-control" id="nbheure" type="text" placeholder="x+x+x">
          </div>

          <div class="col-lg-3">
            <input type="submit" id="action" class="btn btn-block btn-success" value="Attribuer" />
          </div>
        </div>
      </div>

      <button class="accordion">Planification Pivotal Tracker</button>
      <div class="panel">
        <div class='row'>
           <div class='col'>
            <input class="form-control" id="LaRechercheDansPivotal" type="text" placeholder="Rechercher dans le result">
           </div>
           <div class='col'>
            <button id="ChercherApiPivotal" class="btn px-5 btn-info">Rechercher</button>
           </div>
        </div>

        <div id="AucuneStorie" class="hideElement mt-3">
          <h3>Aucunes storie pour ce projet ?</h3>
          <label>
            Si vous êtes sûr du contraire, le problème peut provenir de différentes raisons
            <ul>
              <li>La ressource n'est pas owner des stories ? </li>
              <li>L'ID pivotal tracker du projet ou de la ressource n'est pas le bon ?</li>
            </ul>
          </label>
        </div>
        <div id="ListeTachesApi" class="mt-3"></div>
    
        </div>

        <button class="accordion">Objectifs</button>
        <div class="panel">
            <textarea class="form-control" placeholder="Faire.." id="LabelObjectif" rows="2"></textarea>

            <button type="submit" class="btn btn-success EnvoyerObjectif mt-2 mb-1">Attribuer</button>
        </div>

        <button class="accordion">Démos</button>
        <div class="panel">
          <input class="form-control" id="LabelDemo" type="text" placeholder="Présentation de..">

          <button id="postDemo" class="btn btn-success mb-1 mt-2">Attribuer</button>
        </div>

      </div>
      <div class="modal-footer">
        <input type="number" id="TotalHeureAttribuable" class="form-control" readonly>
        <button  class="btn btn-dark" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<div id="ModalScrumPlaning" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">

        <div class="form-group">
          <label>Type de tâche</label>
          <div id="ListTypeTache"></div>
        </div>

        <div class="form-group">
          <label>Nombre d'heures</label>
          <input class="form-control" id="nbheure2" type="number" min="1" value="1">
        </div>

      </div>
      <div class="modal-footer">
        <input type="submit" class="btn btn-success AttribuerHeureScrumPlaning" />
        <button  class="btn btn-dark" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<div id="ModalGestionHeuresDescendues" class="modal fade">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-body">

        <div class="form-group">
          <label>Projet</label>
          <div id="ListProjetEditionTache"></div>
        </div>

        <div class="form-group">
          <label>Nombre heures</label>
          <input class="form-control" id="nbheureEditionTache" type="number" min="1"
            value="1">
        </div>

        <div class="form-group">
          <label>Label</label>
          <input class="form-control" id="LabelTache" type="text">
        </div>

        <div class="form-group">
          <label>Date</label>
          <input type="date" id='Done' class="form-control" />
        </div>

      </div>

      <div class="modal-footer">
        <input id="id_planif" type="text" placeholder="id ModalGestionHeuresDescendues" class="form-control" readonly/>
        <input type="submit" id="actionEditionTache" class="btn btn-success" value="Sauvegarder" />
        <button class="btn btn-dark" data-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>

<script>
  $(document).ready(function () {

    $.ajax({
        url: "Modele/Planification.php",
        method: "POST",
        dataType: "json",
        data: {
          action: "RessourcePivotalPerso",
        },
        success: function (data) {
          $('#ListEmployePivotal').val(data.user_pk + '|'+data.user_apiPivotal);
        }
      });

    RequeteAjax('ListSrint', 'ListeDeroulanteSprint', 'Modele/RequetesAjax.php');
    RequeteAjax('ListProjetEditionTache', 'ListeDeroulanteProjet', 'Modele/RequetesAjax.php',
      'ListeProjeteditionTache');
    RequeteAjax('ListProjetPivotal', 'ProjetPivotal', 'Modele/RequetesAjax.php');
    RequeteAjax('ListTypeTache', 'RemplirTypeTache', 'Modele/RequetesAjax.php');

    $("#ProjetApi").select2({width: "100%"});

      var acc = document.getElementsByClassName("accordion");
      var i;

      for (i = 0; i < acc.length; i++) {
        acc[i].addEventListener("click", function () {
          this.classList.toggle("active");
          var panel = this.nextElementSibling;
          if (panel.style.maxHeight) {
            panel.style.maxHeight = null;
            panel.style.border = null;
          } else {
            panel.style.maxHeight = "max-content";
            panel.style.border = "1px solid";
          }
        });
      }

    //Permet de rechercher dans les stories que pivotal a trouvé
    $('#LaRechercheDansPivotal').keyup(function () {

      var searchWord = $('#LaRechercheDansPivotal').val()

      $(".HeaderTablePlanif").each(function () {

        if ($(this).text().toLowerCase().includes(searchWord.toLowerCase())) {
          $(this).closest('table').show()
        } else {
          $(this).closest('table').hide()
        }

      });
    })
    

    RemplirTableau('TableListHeuresAttribuees');
    // RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')

    BarreDeRecherche('BarreDeRecherche', 'TableListHeuresAttribuees');

    var ApiPivotalKey = ""

    $.ajax({
      url: "Modele/Autre.php",
      method: "POST",
      async: 'false',
      data: {
        action: "getApiPivotalKey"
      },
      success: function (data) {
        ApiPivotalKey = data.trim()
      }
    })

    //Remplir le tableu avec toutes les tâches de tout le monde
    function RemplirTableau(Div) {
      $.ajax({
        url: "Modele/Planification.php",
        method: "POST",
        data: {
          action: "RemplirTableauPerso",
          idAffiche: $('#numeroSprint').val()
        },
        success: function (data) {
          $('#' + Div).html(data);
          GarderLaRecherche('BarreDeRecherche', 'TableListHeuresAttribuees');

          //Checker si doublons
          $('#TableListHeuresAttribuees tr').each (function() {
            var LaValueACheck = this.innerText
            var LeIndexACheck = $(this).index()

            $('#TableListHeuresAttribuees tr').each (function() {
              
              if(LaValueACheck == this.innerText && LeIndexACheck != $(this).index() && $(this)[0].cells[2].innerText != "Label inconnue"){
                $(this).addClass('bg-warning')   
              }

            });    

          }); 
        }
      });
    }

    //Petite infos quand planifie qui indique combiens d'heures encore planifiables
    function HeureAttribuable1Ressource() {
      $.ajax({
        url: "Modele/Planification.php",
        method: "POST",
        data: {
          action: "NbHeureRestantePlanifiable",
          Sprint: $('#numeroSprint').val(),
          Employe: $('#ListEmployePivotal').val().split('|')[0]
        },
        dataType: "json",
        success: function (data) {
          $('#TotalHeureAttribuable').val(data.Attribuable);
          document.getElementById("totalheure").innerHTML = "Planifiables<br><b>" + data.Attribuable + "</b> h"
        }
      });
    }

    //Si le numéro de sprint change, tout recharger
    $('#numeroSprint').change(function () {
      RemplirTableau('TableListHeuresAttribuees');
      // RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
    });

    //delete une tache sur le bouton de delete
    $(document).on('click', '.delete', function () {
      if (confirm("Es-tu sûr de vouloir supprimer cette tâche ?"))
        $.ajax({
          url: "Modele/Tache.php",
          method: "POST",
          data: {
            id: $(this).attr("id"),
            action: "DeleteTache"
          },
          success: function (data) {
            RemplirTableau('TableListHeuresAttribuees');
            // RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
            $.notify(data, "success");
          }
        })
    });

    //Remplie le modal avec les infos de la tache a éditer
    $(document).on('click', '.update', function () {
      var id = $(this).attr("id");
      $.ajax({
        url: "Modele/Tache.php",
        method: "POST",
        data: {
          id: id,
          action: "GetTache"
        },
        dataType: "json",
        success: function (data) {
          $('#ModalGestionHeuresDescendues').modal('show');
          $('#id_planif').val(id);
          $('#idSprint').val(data.id_Sprint);
          $('#ListeProjeteditionTache').val(data.id_Projet);
          $('#nbheureEditionTache').val(data.heure);
          $('#LabelTache').val(data.Label);
          $('#Done').val(data.Done);

          $("#ListeProjeteditionTache").select2({
            width: "100%"
          });
        }
      });
    });

    //Maj de la tache envoyée au back
    $('#actionEditionTache').click(function () {
      $.ajax({
        url: "Modele/Tache.php",
        method: "POST",
        data: {
          id: $('#id_planif').val(),
          Done: $('#Done').val(),
          idSprint: $('#numeroSprint').val(),
          idProjet: $('#ListeProjeteditionTache').val(),
          idEmploye: $('#ListEmployePivotal').val().split('|')[0],
          NombreHeure: $('#nbheureEditionTache').val(),
          Label: $('#LabelTache').val(),
          action: "UpdateTache"
        },
        success: function (data) {
          $.notify(data, "success");
          $('#ModalGestionHeuresDescendues').modal('hide');
          RemplirTableau('TableListHeuresAttribuees');
        }
      });
    });

    //Click sur le bouton pour planifier des heures
    $('#Boutton_Modal_ApiPivotal').click(function () {
      HeureAttribuable1Ressource();
      document.getElementById("ListeTachesApi").innerHTML = ""
      $('#ModalApi').modal('show');
      $('#EnvoyerApiPivotal').hide()
    });

    //Planifier des heures selon le mode x+x+x
    $('#action').click(function () {
      var erreur = false

      if ($('#nbheure').attr('type') == 'text') {
        var NombreHeure = $('#nbheure').val().split('+').map(function (item) {
          return parseInt(item);
        });

        NombreHeure.forEach(function (element) {
          if (isNaN(element))
            erreur = true
        });
      } else
        var NombreHeure = $('#nbheure').val()

      if (erreur == false) {

        $.ajax({
          url: "Modele/Planification.php",
          method: "POST",
          data: {
            idSprint: $('#numeroSprint').val(),
            idProjet: $('#ProjetApi').val().split('|')[0],
            idEmploye: $('#ListEmployePivotal').val().split('|')[0],
            NombreHeure: NombreHeure,
            action: "Attribuer"
          },
          success: function (data) {
            $.notify(data, "success");
            RemplirTableau('TableListHeuresAttribuees');
            // RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
            HeureAttribuable1Ressource()
          }
        });

        $('#nbheure').val('');
      } else $.notify("Le champ d'heure comporte une erreur", "error");

    });

    //Planifier des heures spéciales scrum planing
    $(document).on('click', '.AttribuerHeureScrumPlaning', function () {

      let tableau1ressource = new Array
      tableau1ressource.push($('#ListEmployePivotal').val().split('|')[0])

        $.ajax({
          url: "Modele/Planification.php",
          method: "POST",
          data: {
            idSprint: $('#numeroSprint').val(),
            idEmploye: tableau1ressource,
            NombreHeure: $('#nbheure2').val(),
            idTypeTache: $('#RemplirTypeTache1').val(),
            action: "AttributionScrumPlaning"
          },
          success: function (data) {
            $.notify(data, "success");
            RemplirTableau('TableListHeuresAttribuees');
            // RemplirTableauProjets('TableauListeHeuresAttrbueesProjets')
          }
        });
    });

    $(document).on('click', '#postDemo', function () {

      $.ajax({
        url: "Modele/Retrospective_demo.php",
        method: "POST",
        data: {
          idEmploye: $('#ListEmployePivotal').val().split('|')[0],
          idProjet: $('#ProjetApi').val().split('|')[0],
          LabelDemo: $('#LabelDemo').val(),
          action: "addDemo"
        },
        success: function (data) {
          Notify(data, 'Démo créée')
        }
      });
      $('#LabelDemo').val('');
    });

    //Créer des objectifs
    $(document).on('click', '.EnvoyerObjectif', function () {
      
      if($('#LabelObjectif').val() == ""){
        $.notify("Pas d'objectifs vide", "warning");
      }
      else{
        $.ajax({
        url: "Modele/Retrospective_objectif.php",
        method: "POST",
        data: {
          idSprint: $('#numeroSprint').val(),
          LabelObjectif: $('#LabelObjectif').val(),
          idEmploye: $('#ListEmployePivotal').val().split('|')[0],
          idProjet: $('#ProjetApi').val().split('|')[0],
          action: "Créer"
        },
        success: function (data) {
          $.notify(data, "success");
          $('#LabelObjectif').val('');
        }
      });
      }
      
    });

    //Click sur le bouton pour chercher toutes les heures planifiable sur pivotal tracker
    $('#ChercherApiPivotal').click(function () {

      $("#ChercherApiPivotal").attr("disabled", true).text('Recherche en cours.. ').append('<span id="logochargement" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>');

      document.getElementById("ListeTachesApi").innerHTML = ""
      $('#AucuneStorie').addClass('hideElement')

      $('#EnvoyerApiPivotal').hide()

      var htmlDeFin = ""

      var myStories

      console.log('🎁 Projet: ' + $("#ProjetApi option:selected").text())

      ////////////////////////////////// Requette qui récupère toutes les stories d'une ressource sur le projet sélectionné
      $.ajax({
        url: "https://www.pivotaltracker.com/services/v5/projects/" + $('#ProjetApi').val().split('|')[1] +
          "/stories",
        beforeSend: function (xhr) {
          xhr.setRequestHeader('X-TrackerToken', ApiPivotalKey);
        },
        type: 'GET',
        dataType: 'json',
        contentType: 'application/json',
        processData: false,
        data: 'filter=mywork:' + $('#ListEmployePivotal').val().split('|')[1],
        error: function (XMLHttpRequest, textStatus, errorThrown) {
          $('#AucuneStorie').removeClass('hideElement')
          $("#ChercherApiPivotal").attr("disabled", false).text('Rechercher');
        },
        success: function (data) {
          //Liste des stories trouvées
          myStories = data;

          ////////////////////////////////////////// Pour chaques stories trouvé, sortir chaque taches
          $.each(myStories, function () {

            Storyname = this.name
            StoryId = this.id
            Storyurl = this.url

            $.ajax({
              url: "https://www.pivotaltracker.com/services/v5/projects/" + $('#ProjetApi').val()
                .split('|')[1] + "/stories/" + this.id + "/tasks",
              beforeSend: function (xhr) {
                xhr.setRequestHeader('X-TrackerToken', ApiPivotalKey);
              },
              async: false,
              type: 'GET',
              dataType: 'json',
              contentType: 'application/json',
              processData: false,
              success: function (LesTaches) {
                console.log('   📙 Storie: ' + Storyname)
                htmlDeFin +=
                  '<table class="table table-sm thead-dark table-bordered"><tbody class="thead-dark"><tr><th colspan="10"><u><a class="HeaderTablePlanif" href=' +
                  Storyurl + '>' + Storyname + '</a></u> 🔗</th></tr>';

                $.each(LesTaches, function () {
                  try {
                    var ListeHeures = /\.-(.+)/.exec(this.description)[1];
                    console.log('       📃 Une tache à faire : ' + this.description)
                  } catch {
                    console.log("       🔴🔴🔴🔴" + this.description)
                  }

                  var RegexGroupeHeure = /([0-9]+)/g
                  var InputHeure = '<tr><td class=Tache' + this.complete +
                    '><select id="LeSelectId" onchange="TotalHoursChecked()"><option value="NON">NON</option>'

                  match = RegexGroupeHeure.exec(ListeHeures);
                  while (match != null) {
                    InputHeure += '<option value=' + match[0] + '>' + match[0] + '</option>'
                    match = RegexGroupeHeure.exec(ListeHeures);
                  }
                  InputHeure += '</select>'
                  htmlDeFin += InputHeure + ' <span id="TaskDescription">' + this
                    .description + '</span><span id="StoryId" class="hideElement">' +
                    StoryId + '</span><span id="TaskId" class="hideElement">' + this.id +
                    '</span></td></tr>'
                })
                htmlDeFin += "</tbody></table>"

                document.getElementById("ListeTachesApi").innerHTML = htmlDeFin
              }
            });
          })

          $("#ChercherApiPivotal").attr("disabled", false).text('Rechercher');

          //si pas de stories
          if (myStories.length === 0) {
            $('#AucuneStorie').removeClass('hideElement')
          } else {
            $('#EnvoyerApiPivotal').show()
          }
        }
      });
    })

    //Click sur le bouton flottant vert attribuer des heures planifiées pivotal
    $('#EnvoyerApiPivotal').click(function () {
      if (TotalHoursChecked().length > 2)
        $.ajax({
          url: "Modele/Planification.php",
          method: "POST",
          data: {
            action: "CreerTacheApi",
            ListeTaches: TotalHoursChecked(),
            Sprint: $('#numeroSprint').val(),
            Employe: $('#ListEmployePivotal').val().split('|')[0],
            Projet: $('#ProjetApi').val().split('|')[0]
          },
          success: function (data) {
            RemplirTableau('TableListHeuresAttribuees');
            $.notify(data, "success");
            document.getElementById("ListeTachesApi").innerHTML = ""
            HeureAttribuable1Ressource();
            $('#EnvoyerApiPivotal').hide()
          }
        });

      else
        $.notify("Aucune tâche n'est sélectionnée", "error");
    })

  });

  //Lorsque click sur le bouton flottant vert attribuer des heures planifiées pivotal, liste toutes les taches qui ne sont pas des "non" et les mettres dans un tableau qui sera envoyé
  function TotalHoursChecked() {

    var cart = [];
    var TotalHeures = 0;

    cart.push({
      'User': $('#ListEmployePivotal').val().split('|')[0]
    });

    cart.push({
      'Project': $('#ProjetApi').val().split('|')[0]
    });

    $('#ListeTachesApi tr td').each(function () {

      if ($(this).children()[0].value != "NON") {
        TotalHeures += parseInt($(this).children('#LeSelectId')[0].options[$(this).children('#LeSelectId')[0]
          .selectedIndex].value);

        element = {}
        element.StoryId = $(this).children('#StoryId').text()
        element.TaskId = $(this).children('#TaskId').text()
        element.ProjectId = $('#ProjetApi').val().split('|')[1]
        element.heure = parseInt($(this).children('#LeSelectId')[0].options[$(this).children('#LeSelectId')[0]
          .selectedIndex].value)
        element.label = /(.+)\.-/.exec($(this).children('#TaskDescription').text())[1].trim();
        element.StoryLabel = ($(this).parent().parent().children()[0].innerText).slice(0, -3)

        if ($(this).hasClass('Tachetrue'))
          element.done = new Date().toJSON().split('T')[0]
        else
          element.done = null

        cart.push(element)
      }

    })

    document.getElementById("totalheure").innerHTML = "Planifiables<br><b>" + ($('#TotalHeureAttribuable').val() - TotalHeures) + "</b> h"

    return cart
  }

</script>